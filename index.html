<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARAN</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #ffffff;
            --text: #000000;
            --gray: #f4f4f4;
            --dark-gray: #7a7a7a;
            --accent: #000000;
            --error: #ff3b30;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            font-family: 'Montserrat', sans-serif;
        }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            overflow-x: hidden; 
        }

        /* –•–µ–¥–µ—Ä */
        .header {
            position: sticky;
            top: 0;
            background: #fff;
            z-index: 1000;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--gray);
        }

        .brand { font-weight: 800; font-size: 20px; letter-spacing: 3px; text-transform: uppercase; }

        .search-bar {
            padding: 10px 20px;
            background: var(--gray);
            margin: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .search-bar input {
            border: none;
            background: transparent;
            width: 100%;
            font-size: 14px;
            outline: none;
        }

        /* –ö–∞—Ç–µ–≥–æ—Ä–∏–∏ */
        .categories-scroll {
            display: flex;
            overflow-x: auto;
            padding: 10px 15px;
            gap: 10px;
            scrollbar-width: none;
        }
        .categories-scroll::-webkit-scrollbar { display: none; }
        .cat-btn {
            padding: 10px 20px;
            border: 1px solid var(--text);
            background: #fff;
            white-space: nowrap;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 600;
            cursor: pointer;
            transition: 0.2s;
        }
        .cat-btn.active { background: var(--text); color: #fff; }

        /* –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1px;
            background: var(--gray);
            border-top: 1px solid var(--gray);
            border-bottom: 1px solid var(--gray);
        }
        .product-card {
            background: #fff;
            padding: 10px;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .img-slider {
            width: 100%;
            aspect-ratio: 3/4;
            overflow: hidden;
            position: relative;
        }
        .img-slider img { width: 100%; height: 100%; object-fit: cover; }
        
        .badge-sale {
            position: absolute; top: 5px; left: 5px; background: #000; color: #fff;
            font-size: 9px; padding: 3px 6px; font-weight: 800;
        }

        .product-info { padding: 10px 0; text-align: left; }
        .p-title { font-size: 12px; font-weight: 400; margin-bottom: 4px; text-transform: uppercase; height: 15px; overflow: hidden; }
        .p-price { font-size: 14px; font-weight: 800; }
        .p-old-price { font-size: 12px; text-decoration: line-through; color: var(--dark-gray); margin-left: 5px; }

        .size-row { display: flex; gap: 5px; margin: 8px 0; flex-wrap: wrap; }
        .size-tag { font-size: 9px; border: 1px solid var(--gray); padding: 2px 5px; color: var(--dark-gray); }

        /* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
        .card-actions { display: flex; gap: 5px; margin-top: auto; }
        .btn-black { 
            background: #000; color: #fff; border: none; padding: 12px; 
            font-size: 10px; font-weight: 600; text-transform: uppercase; flex: 1;
        }
        .btn-fav { background: var(--gray); border: none; width: 40px; display: flex; align-items: center; justify-content: center; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav {
            position: fixed; bottom: 0; width: 100%; background: #fff;
            border-top: 1px solid var(--gray); display: flex; padding: 10px 0 25px;
            z-index: 2000;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            gap: 4px; font-size: 9px; text-transform: uppercase; font-weight: 600; color: var(--dark-gray);
            background: none; border: none; position: relative;
        }
        .nav-item.active { color: var(--text); }
        .nav-item svg { width: 22px; height: 22px; }
        .cart-badge {
            position: absolute; top: -5px; right: 20%; background: var(--error);
            color: #fff; font-size: 9px; width: 15px; height: 15px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        /* Full View Modal */
        .full-view {
            position: fixed; inset: 0; background: #fff; z-index: 3000;
            overflow-y: auto; padding-bottom: 100px;
        }
        .close-view { position: fixed; top: 20px; right: 20px; z-index: 3100; background: #000; color: #fff; border: none; width: 40px; height: 40px; }
        
        .view-content { padding: 20px; }
        .view-price { font-size: 24px; font-weight: 800; margin: 15px 0; }
        .view-desc { font-size: 14px; line-height: 1.6; color: var(--dark-gray); margin-bottom: 25px; }
        
        .size-selector { display: flex; gap: 10px; margin-bottom: 30px; }
        .size-box { 
            border: 1px solid #000; padding: 15px; min-width: 50px; text-align: center;
            font-size: 14px; font-weight: 600; 
        }
        .size-box.active { background: #000; color: #fff; }

        /* –ê–¥–º–∏–Ω–∫–∞ */
        .admin-section { padding: 20px; background: #fafafa; margin-top: 20px; border-top: 2px solid #000; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 11px; font-weight: 700; text-transform: uppercase; margin-bottom: 5px; }
        .naran-input { width: 100%; padding: 12px; border: 1px solid #ddd; outline: none; border-radius: 0; }
        .naran-input:focus { border-color: #000; }

        /* –ö–∞—Ä—Ç–∞ */
        #map { width: 100%; height: 300px; margin-top: 15px; border: 1px solid #000; }
        
        /* –°—Ç–∞—Ç—É—Å—ã –∑–∞–∫–∞–∑–æ–≤ */
        .order-card { border: 1px solid var(--gray); padding: 15px; margin-bottom: 10px; font-size: 13px; }
        .status-badge { display: inline-block; padding: 4px 8px; font-size: 10px; background: #000; color: #fff; margin-top: 8px; }

        .empty-state { text-align: center; padding: 100px 20px; color: var(--dark-gray); text-transform: uppercase; font-size: 12px; letter-spacing: 1px; }
    </style>
</head>
<body>

<div id="app">
    <header class="header">
        <button @click="showSidebar = true; vibro()" style="background:none; border:none; padding:0;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <div class="brand">NARAN</div>
        <button @click="toggleSearch" style="background:none; border:none; padding:0;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </button>
    </header>

    <div v-if="showSidebar" @click="showSidebar = false" style="position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:4000;"></div>
    <div :style="{ transform: showSidebar ? 'translateX(0)' : 'translateX(-100%)' }" style="position:fixed; top:0; left:0; bottom:0; width:80%; background:#fff; z-index:4001; transition: 0.3s; padding: 40px 20px;">
        <div class="brand" style="margin-bottom: 40px;">NARAN</div>
        <div style="display: flex; flex-direction: column; gap: 25px;">
            <div @click="openInfo('about')">–û –ù–ê–°</div>
            <div @click="openInfo('delivery')">–î–û–°–¢–ê–í–ö–ê</div>
            <div @click="openInfo('return')">–í–û–ó–í–†–ê–¢</div>
        </div>
        
        <div v-if="infoTab" style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px; font-size: 14px; line-height: 1.6;">
            <div v-if="infoTab === 'about'">NARAN ‚Äî —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –±—Ä–µ–Ω–¥ –ø—Ä–µ–º–∏–∞–ª—å–Ω–æ–π –±–∞–∑–æ–≤–æ–π –æ–¥–µ–∂–¥—ã. –ú—ã –≤–µ—Ä–∏–º –≤ –∫–∞—á–µ—Å—Ç–≤–æ –≤–Ω–µ –≤—Ä–µ–º–µ–Ω–∏.</div>
            <div v-if="infoTab === 'delivery'">–î–æ—Å—Ç–∞–≤–∫–∞ –ø–æ –≤—Å–µ–π –†–§ —á–µ—Ä–µ–∑ –°–î–≠–ö, –ü–æ—á—Ç—É –†–æ—Å—Å–∏–∏ –∏ 5Post. –°—Ä–æ–∫–∏: –æ—Ç 2 –¥–æ 10 –¥–Ω–µ–π.</div>
            <div v-if="infoTab === 'return'">–í–æ–∑–≤—Ä–∞—Ç –≤–æ–∑–º–æ–∂–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –±–∏—Ä–æ–∫.</div>
        </div>
    </div>

    <main style="padding-bottom: 100px;">
        
        <div v-if="activeTab === 'catalog'">
            <div v-if="searchActive" class="search-bar">
                <input v-model="searchQuery" placeholder="–ü–û–ò–°–ö –ü–û –ù–ê–ó–í–ê–ù–ò–Æ..." focus>
            </div>

            <div class="categories-scroll">
                <button @click="currentCat = ''; vibro()" :class="['cat-btn', currentCat === '' ? 'active' : '']">–í–°–ï –¢–û–í–ê–†–´</button>
                <button v-for="cat in dynamicCategories" :key="cat" @click="currentCat = cat; vibro()" :class="['cat-btn', currentCat === cat ? 'active' : '']">
                    {{ cat }}
                </button>
            </div>

            <div class="grid">
                <div v-for="p in filteredProducts" :key="p.id" class="product-card" @click="openProduct(p)">
                    <div class="img-slider">
                        <div v-if="p.oldPrice" class="badge-sale">SALE</div>
                        <img :src="p.images ? p.images[0] : p.img">
                    </div>
                    <div class="product-info">
                        <div class="p-title">{{ p.title }}</div>
                        <div class="p-price">
                            {{ p.price }} ‚ÇΩ
                            <span v-if="p.oldPrice" class="p-old-price">{{ p.oldPrice }} ‚ÇΩ</span>
                        </div>
                        <div class="size-row">
                            <span v-for="s in p.sizes" :key="s" class="size-tag">{{ s }}</span>
                        </div>
                    </div>
                    <div class="card-actions" @click.stop>
                        <button class="btn-fav" @click="toggleFav(p)">
                            <svg :fill="isFav(p) ? 'black' : 'none'" width="18" height="18" viewBox="0 0 24 24" stroke="black" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                        </button>
                        <button class="btn-black" @click="quickAdd(p)">–í –ö–û–†–ó–ò–ù–£</button>
                    </div>
                </div>
            </div>
            <div v-if="filteredProducts.length === 0" class="empty-state">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        </div>

        <div v-if="activeTab === 'favs'">
            <div style="padding: 20px; font-weight: 800; text-transform: uppercase;">–ò–ó–ë–†–ê–ù–ù–û–ï</div>
            <div v-if="favItems.length === 0" class="empty-state">–í–∞—à —Å–ø–∏—Å–æ–∫ –∂–µ–ª–∞–Ω–∏–π –ø—É—Å—Ç</div>
            <div class="grid">
                <div v-for="p in favItems" :key="p.id" class="product-card" @click="openProduct(p)">
                    <div class="img-slider"><img :src="p.img"></div>
                    <div class="product-info">
                        <div class="p-title">{{ p.title }}</div>
                        <div class="p-price">{{ p.price }} ‚ÇΩ</div>
                    </div>
                    <button class="btn-black" @click.stop="toggleFav(p)">–£–î–ê–õ–ò–¢–¨</button>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'cart'">
            <div style="padding: 20px; font-weight: 800; text-transform: uppercase;">–ö–û–†–ó–ò–ù–ê</div>
            <div v-if="cart.length === 0" class="empty-state">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
            
            <div v-else style="padding: 0 20px;">
                <div v-for="(item, idx) in cart" :key="idx" style="display:flex; gap:15px; padding:15px 0; border-bottom:1px solid #eee;">
                    <img :src="item.img" style="width:70px; height:90px; object-fit:cover;">
                    <div style="flex:1;">
                        <div style="font-size:12px; font-weight:600;">{{ item.title }}</div>
                        <div style="font-size:10px; color:var(--dark-gray); margin: 5px 0;">–†–ê–ó–ú–ï–†: {{ item.selectedSize }} | –¶–í–ï–¢: {{ item.selectedColor }}</div>
                        <div style="display:flex; align-items:center; gap:10px; margin-top:5px;">
                            <button @click="changeQty(idx, -1)" style="border:1px solid #000; background:none; width:25px; height:25px;">-</button>
                            <span>{{ item.qty }}</span>
                            <button @click="changeQty(idx, 1)" style="border:1px solid #000; background:none; width:25px; height:25px;">+</button>
                        </div>
                    </div>
                    <div style="text-align:right;">
                        <div style="font-weight:800;">{{ item.price * item.qty }} ‚ÇΩ</div>
                        <button @click="removeFromCart(idx)" style="background:none; border:none; color:red; font-size:10px; margin-top:10px;">–£–î–ê–õ–ò–¢–¨</button>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <div class="input-group">
                        <label>–ò–ú–Ø</label>
                        <input v-model="orderForm.name" class="naran-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                    </div>
                    <div class="input-group">
                        <label>–¢–ï–õ–ï–§–û–ù</label>
                        <input v-model="orderForm.phone" class="naran-input" type="tel" placeholder="79000000000">
                    </div>
                    
                    <label style="font-size:11px; font-weight:700;">–°–ü–û–°–û–ë –î–û–°–¢–ê–í–ö–ò</label>
                    <div style="display:flex; gap:5px; margin: 10px 0;">
                        <button v-for="d in ['–°–î–≠–ö', '–ü–û–ß–¢–ê', '5POST']" @click="setDelivery(d)" :class="['cat-btn', orderForm.delivery === d ? 'active' : '']" style="flex:1;">{{ d }}</button>
                    </div>

                    <div v-if="orderForm.delivery">
                        <div style="font-size:11px; margin-bottom:10px;">üìç {{ orderForm.address || '–í—ã–±–µ—Ä–∏—Ç–µ –ø—É–Ω–∫—Ç –Ω–∞ –∫–∞—Ä—Ç–µ' }}</div>
                        <div id="map"></div>
                    </div>

                    <div style="margin: 30px 0; border-top: 2px solid #000; padding-top: 20px;">
                        <div style="display:flex; justify-content:space-between; font-weight:800; font-size:18px;">
                            <span>–ò–¢–û–ì–û:</span>
                            <span>{{ cartTotal }} ‚ÇΩ</span>
                        </div>
                        <button class="btn-black" style="width:100%; padding:20px; margin-top:20px;" :disabled="!isOrderValid" @click="submitOrder">–û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó</button>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'profile'">
            <div style="text-align:center; padding: 40px 20px;">
                <img :src="user.photo_url || 'https://ui-avatars.com/api/?name=' + user.first_name" style="width:80px; height:80px; border-radius:50%; border:1px solid #000; padding:5px;">
                <div style="margin-top:15px; font-weight:800; font-size:18px;">{{ user.first_name }}</div>
                <button @click="openSupport" class="cat-btn" style="margin-top:15px;">–ü–û–î–î–ï–†–ñ–ö–ê (TG)</button>
            </div>

            <div style="padding: 0 20px;">
                <div style="font-weight:800; border-bottom:1px solid #000; padding-bottom:10px; margin-bottom:15px;">–ú–û–ò –ó–ê–ö–ê–ó–´</div>
                <div v-if="userOrders.length === 0" style="font-size:12px; color:var(--dark-gray);">–£ –≤–∞—Å –µ—â–µ –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤</div>
                <div v-for="ord in userOrders" :key="ord.id" class="order-card">
                    <div style="display:flex; justify-content:space-between;">
                        <b>‚Ññ {{ ord.order_id }}</b>
                        <span>{{ ord.total }} ‚ÇΩ</span>
                    </div>
                    <div class="status-badge">{{ ord.status || '–í –û–ë–†–ê–ë–û–¢–ö–ï' }}</div>
                    <div style="font-size:10px; color:gray; margin-top:5px;">{{ ord.delivery }} - {{ ord.address }}</div>
                </div>
            </div>

            <div v-if="isAdmin" class="admin-section">
                <div style="font-weight:800; font-size:20px; margin-bottom:20px;">ADMIN PANEL</div>
                
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:20px;">
                    <div style="background:#000; color:#fff; padding:15px;">
                        <div style="font-size:10px;">–ü–†–û–î–ê–ñ–ò</div>
                        <div style="font-size:18px; font-weight:800;">{{ stats.revenue }} ‚ÇΩ</div>
                    </div>
                    <div style="background:#fff; border:1px solid #000; padding:15px;">
                        <div style="font-size:10px;">–ó–ê–ö–ê–ó–´</div>
                        <div style="font-size:18px; font-weight:800;">{{ stats.count }}</div>
                    </div>
                </div>

                <div style="background:#fff; padding:15px; border:1px solid #eee; margin-bottom:20px;">
                    <h4 style="margin:0 0 15px 0;">–ù–û–í–´–ô –¢–û–í–ê–†</h4>
                    <div class="input-group">
                        <label>–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</label>
                        <input type="file" multiple @change="uploadImages" class="naran-input">
                        <div v-if="isUploading" style="font-size:10px; margin-top:5px;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                    <input v-model="newProduct.title" class="naran-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" style="margin-bottom:10px;">
                    <textarea v-model="newProduct.desc" class="naran-input" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ" style="margin-bottom:10px; height:80px;"></textarea>
                    
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <input v-model.number="newProduct.price" class="naran-input" placeholder="–¶–µ–Ω–∞">
                        <input v-model.number="newProduct.oldPrice" class="naran-input" placeholder="–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞">
                    </div>
                    
                    <input v-model="newProduct.sizes" class="naran-input" placeholder="–†–∞–∑–º–µ—Ä—ã (S, M, L)" style="margin-bottom:10px;">
                    <input v-model="newProduct.colors" class="naran-input" placeholder="–¶–≤–µ—Ç–∞ (Black, White)" style="margin-bottom:10px;">
                    
                    <select v-model="newProduct.category" class="naran-input" style="margin-bottom:10px;">
                        <option value="">–ö–ê–¢–ï–ì–û–†–ò–Ø</option>
                        <option v-for="c in dynamicCategories" :value="c">{{ c }}</option>
                    </select>

                    <button class="btn-black" @click="saveProduct" :disabled="isUploading" style="width:100%;">–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨</button>
                </div>

                <div style="background:#fff; padding:15px; border:1px solid #eee;">
                    <h4 style="margin:0 0 15px 0;">–í–°–ï –ó–ê–ö–ê–ó–´</h4>
                    <div v-for="ord in allOrders" :key="ord.id" class="order-card">
                        <div><b>{{ ord.user.name }}</b> ({{ ord.user.phone }})</div>
                        <div>{{ ord.total }} ‚ÇΩ - {{ ord.delivery }}</div>
                        <select @change="updateOrderStatus(ord.id, $event.target.value)" style="margin-top:10px;">
                            <option :selected="ord.status === '–í –û–ë–†–ê–ë–û–¢–ö–ï'">–í –û–ë–†–ê–ë–û–¢–ö–ï</option>
                            <option :selected="ord.status === '–í –ü–£–¢–ò'">–í –ü–£–¢–ò</option>
                            <option :selected="ord.status === '–ì–û–¢–û–í'">–ì–û–¢–û–í</option>
                        </select>
                        <button @click="printOrder(ord)" style="font-size:9px; margin-left:10px;">–ü–ï–ß–ê–¢–¨ –ß–ï–ö–ê</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div v-if="selProduct" class="full-view">
        <button class="close-view" @click="selProduct = null">‚úï</button>
        <div class="img-slider" style="aspect-ratio: 1/1.2;">
            <img :src="selProduct.images[activeImgIdx]">
            <div style="position:absolute; bottom:20px; width:100%; display:flex; justify-content:center; gap:5px;">
                <div v-for="(img, i) in selProduct.images" @click="activeImgIdx = i" :style="{ background: i === activeImgIdx ? '#000' : '#ccc' }" style="width:8px; height:8px; border-radius:50%;"></div>
            </div>
        </div>
        <div class="view-content">
            <h1 style="font-size:20px; letter-spacing:1px; margin:0;">{{ selProduct.title }}</h1>
            <div class="view-price">{{ selProduct.price }} ‚ÇΩ</div>
            <p class="view-desc">{{ selProduct.desc }}</p>
            
            <label style="font-size:11px; font-weight:800;">–í–´–ë–ï–†–ò–¢–ï –†–ê–ó–ú–ï–†</label>
            <div class="size-selector">
                <div v-for="s in selProduct.sizes" @click="selSize = s; vibro()" :class="['size-box', selSize === s ? 'active' : '']">{{ s }}</div>
            </div>

            <label style="font-size:11px; font-weight:800;">–í–´–ë–ï–†–ò–¢–ï –¶–í–ï–¢</label>
            <div class="size-selector">
                <div v-for="c in selProduct.colors" @click="selColor = c; vibro()" :class="['size-box', selColor === c ? 'active' : '']">{{ c }}</div>
            </div>

            <div style="display:flex; gap:10px; margin-top:40px;">
                <button class="btn-fav" style="width:60px; height:60px;" @click="toggleFav(selProduct)">
                    <svg :fill="isFav(selProduct) ? 'black' : 'none'" width="24" height="24" viewBox="0 0 24 24" stroke="black" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                </button>
                <button class="btn-black" style="flex:1; height:60px; font-size:14px;" @click="addToCart(selProduct)">–î–û–ë–ê–í–ò–¢–¨ –í –ö–û–†–ó–ò–ù–£</button>
            </div>
        </div>
    </div>

    <nav class="nav">
        <button @click="activeTab = 'catalog'; vibro()" :class="['nav-item', activeTab === 'catalog' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            –∫–∞—Ç–∞–ª–æ–≥
        </button>
        <button @click="activeTab = 'favs'; vibro()" :class="['nav-item', activeTab === 'favs' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            –∏–∑–±—Ä–∞–Ω–Ω–æ–µ
        </button>
        <button @click="activeTab = 'cart'; vibro()" :class="['nav-item', activeTab === 'cart' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
            –∫–æ—Ä–∑–∏–Ω–∞
            <div v-if="cart.length > 0" class="cart-badge">{{ cart.length }}</div>
        </button>
        <button @click="activeTab = 'profile'; vibro()" :class="['nav-item', activeTab === 'profile' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            –ø—Ä–æ—Ñ–∏–ª—å
        </button>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, where } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const fbCfg = {
        apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw",
        authDomain: "naran-80077.firebaseapp.com",
        projectId: "naran-80077",
        storageBucket: "naran-80077.firebasestorage.app",
        messagingSenderId: "901156477154",
        appId: "IG-PR8PLCMF3C"
    };

    const fbApp = initializeApp(fbCfg);
    const db = getFirestore(fbApp);

    const { createApp } = Vue;
    const tg = window.Telegram.WebApp;

    createApp({
        data() {
            return {
                activeTab: 'catalog',
                showSidebar: false,
                infoTab: null,
                searchActive: false,
                searchQuery: '',
                currentCat: '',
                dynamicCategories: ['–ü–ò–î–ñ–ê–ö–ò', '–°–í–ò–¢–ï–†–´', '–ö–û–°–¢–Æ–ú–´', '–õ–û–ù–ì–°–õ–ò–í–´', '–ö–£–†–¢–ö–ò'],
                
                products: [],
                selProduct: null,
                activeImgIdx: 0,
                selSize: '',
                selColor: '',

                cart: JSON.parse(localStorage.getItem('naran_cart') || '[]'),
                favs: JSON.parse(localStorage.getItem('naran_favs') || '[]'),
                
                user: { id: 0, first_name: '–ì–æ—Å—Ç—å', photo_url: '' },
                isAdmin: false,
                adminId: 387881523,

                orderForm: { name: '', phone: '', delivery: '', address: '' },
                userOrders: [],
                allOrders: [],
                stats: { revenue: 0, count: 0 },

                newProduct: { title: '', desc: '', price: '', oldPrice: '', sizes: 'S, M, L', colors: 'Black', category: '', images: [] },
                isUploading: false,
                map: null,
                markers: []
            }
        },
        computed: {
            filteredProducts() {
                try {
                    let list = this.products || [];
                    if (this.currentCat) {
                        list = list.filter(p => p.category && p.category.toLowerCase() === this.currentCat.toLowerCase());
                    }
                    if (this.searchQuery) {
                        list = list.filter(p => p.title.toLowerCase().includes(this.searchQuery.toLowerCase()));
                    }
                    return list.filter(p => !p.hidden);
                } catch(e) { return []; }
            },
            favItems() {
                return this.products.filter(p => this.favs.includes(p.id));
            },
            cartTotal() {
                return this.cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            },
            isOrderValid() {
                return this.orderForm.name.length > 1 && this.orderForm.phone.length > 9 && this.orderForm.address;
            }
        },
        methods: {
            vibro() { tg.HapticFeedback.impactOccurred('medium'); },
            toggleSearch() { this.searchActive = !this.searchActive; if(!this.searchActive) this.searchQuery = ''; },
            openInfo(tab) { this.infoTab = tab; this.vibro(); },
            
            toggleFav(p) {
                const idx = this.favs.indexOf(p.id);
                if(idx > -1) this.favs.splice(idx, 1);
                else this.favs.push(p.id);
                localStorage.setItem('naran_favs', JSON.stringify(this.favs));
                this.vibro();
            },
            isFav(p) { return this.favs.includes(p.id); },

            openProduct(p) {
                this.selProduct = p;
                this.activeImgIdx = 0;
                this.selSize = p.sizes ? p.sizes[0] : '';
                this.selColor = p.colors ? p.colors[0] : '';
                this.vibro();
            },

            addToCart(p) {
                const item = { 
                    id: p.id, 
                    title: p.title, 
                    price: p.price, 
                    img: p.images[0], 
                    selectedSize: this.selSize,
                    selectedColor: this.selColor,
                    qty: 1 
                };
                this.cart.push(item);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
                this.selProduct = null;
                tg.HapticFeedback.notificationOccurred('success');
            },

            quickAdd(p) {
                this.selProduct = p;
                this.addToCart(p);
            },

            changeQty(idx, delta) {
                this.cart[idx].qty += delta;
                if(this.cart[idx].qty < 1) this.cart[idx].qty = 1;
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
            },

            removeFromCart(idx) {
                this.cart.splice(idx, 1);
                localStorage.setItem('naran_cart', JSON.stringify(this.cart));
            },

            setDelivery(type) {
                this.orderForm.delivery = type;
                this.vibro();
                this.$nextTick(() => this.initMap());
            },

            initMap() {
                if(this.map) this.map.destroy();
                this.map = new mapgl.Map('map', {
                    center: [37.6175, 55.7558],
                    zoom: 12,
                    key: 'cab82c94-e619-42eb-9814-3361712feaf0'
                });

                this.map.on('click', (e) => {
                    const [lon, lat] = e.lngLat;
                    this.fetchAddress(lat, lon);
                });

                navigator.geolocation.getCurrentPosition(p => {
                    const coords = [p.coords.longitude, p.coords.latitude];
                    this.map.setCenter(coords);
                    this.fetchAddress(p.coords.latitude, p.coords.longitude);
                });
            },

            async fetchAddress(lat, lon) {
                try {
                    const res = await fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lat=${lat}&lon=${lon}&fields=items.address&key=cab82c94-e619-42eb-9814-3361712feaf0`);
                    const data = await res.json();
                    if(data.result.items.length > 0) {
                        this.orderForm.address = data.result.items[0].address_name || data.result.items[0].name;
                        localStorage.setItem('naran_last_address', this.orderForm.address);
                    }
                } catch(e) { this.orderForm.address = "–ê–¥—Ä–µ—Å –≤—ã–±—Ä–∞–Ω –Ω–∞ –∫–∞—Ä—Ç–µ"; }
            },

            async submitOrder() {
                const orderId = `${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(10000+Math.random()*90000)}`;
                const orderData = {
                    order_id: orderId,
                    user_id: this.user.id,
                    user: this.orderForm,
                    items: this.cart,
                    total: this.cartTotal,
                    status: '–í –û–ë–†–ê–ë–û–¢–ö–ï',
                    createdAt: new Date().getTime()
                };

                await addDoc(collection(db, "orders"), orderData);
                
                // –ë–æ—Ç-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                const text = `üõç –ó–ê–ö–ê–ó ${orderId}\nüë§ ${this.orderForm.name} (${this.orderForm.phone})\nüöö ${this.orderForm.delivery}: ${this.orderForm.address}\nüí∞ –ò–¢–û–ì–û: ${this.cartTotal} ‚ÇΩ`;
                tg.sendData(JSON.stringify(orderData)); // –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –±–æ—Ç–∞

                this.cart = [];
                localStorage.removeItem('naran_cart');
                tg.showAlert("–ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –ù–æ–º–µ—Ä: " + orderId);
                this.activeTab = 'catalog';
            },

            async uploadImages(e) {
                this.isUploading = true;
                const files = e.target.files;
                for(let file of files) {
                    const formData = new FormData();
                    formData.append('image', file);
                    try {
                        const res = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body: formData });
                        const data = await res.json();
                        this.newProduct.images.push(data.data.url);
                    } catch(err) { tg.showAlert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ"); }
                }
                this.isUploading = false;
            },

            async saveProduct() {
                const p = {
                    ...this.newProduct,
                    sizes: this.newProduct.sizes.split(',').map(s => s.trim()),
                    colors: this.newProduct.colors.split(',').map(c => c.trim()),
                    hidden: false
                };
                await addDoc(collection(db, "products"), p);
                tg.showAlert("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω!");
                this.newProduct = { title: '', desc: '', price: '', oldPrice: '', sizes: 'S, M, L', colors: 'Black', category: '', images: [] };
            },

            updateOrderStatus(id, status) {
                updateDoc(doc(db, "orders", id), { status });
            },

            printOrder(ord) {
                const win = window.open('', '_blank');
                win.document.write(`<h1>–ß–ï–ö NARAN - ${ord.order_id}</h1><p>–ö–ª–∏–µ–Ω—Ç: ${ord.user.name}</p><p>–ê–¥—Ä–µ—Å: ${ord.user.address}</p><h3>–°—É–º–º–∞: ${ord.total} —Ä—É–±.</h3>`);
                win.print();
            },

            openSupport() { window.Telegram.WebApp.openTelegramLink('https://t.me/opttania'); }
        },
        mounted() {
            tg.ready();
            tg.expand();
            if(tg.initDataUnsafe?.user) {
                this.user = tg.initDataUnsafe.user;
                this.isAdmin = Number(this.user.id) === this.adminId;
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤
            onSnapshot(query(collection(db, "products")), (snap) => {
                this.products = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            });

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
            if(this.isAdmin) {
                onSnapshot(collection(db, "orders"), (snap) => {
                    this.allOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    this.stats.count = this.allOrders.length;
                    this.stats.revenue = this.allOrders.reduce((s, o) => s + (Number(o.total) || 0), 0);
                });
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–∫–∞–∑–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const qU = query(collection(db, "orders"), where("user_id", "==", this.user.id));
            onSnapshot(qU, (snap) => {
                this.userOrders = snap.docs.map(d => ({ id: d.id, ...d.data() }));
            });
            
            this.orderForm.address = localStorage.getItem('naran_last_address') || '';
        }
    }).mount('#app');
</script>
</body>
</html>
