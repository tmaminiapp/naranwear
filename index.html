<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AUNA jewel</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --accent: #000000; 
            --bg: #ffffff; 
            --card-bg: #ffffff;
            --dark: #1a1a1a; 
            --gray: #8e8e93; 
            --border: #efefef;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--dark); 
            font-family: 'Montserrat', sans-serif; 
            overflow-x: hidden;
            padding-bottom: 100px;
        }

        [v-cloak] { display: none; }

        /* HEADER */
        .header {
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border);
        }

        .logo { font-weight: 800; font-size: 18px; letter-spacing: 3px; text-transform: uppercase; }

        /* ADMIN PANEL INSIDE PROFILE */
        .admin-panel {
            margin-top: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 20px;
            border: 1px solid var(--border);
        }

        .input-ui {
            width: 100%;
            padding: 14px;
            margin-bottom: 12px;
            border: 1px solid var(--border);
            border-radius: 12px;
            font-family: inherit;
        }

        .btn-black {
            background: #000;
            color: #fff;
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
        }

        /* TABS */
        .tab-bar {
            position: fixed;
            bottom: 0;
            width: 100%;
            background: #fff;
            display: flex;
            justify-content: space-around;
            padding: 12px 0 25px;
            border-top: 1px solid var(--border);
            z-index: 1000;
        }

        .tab-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            font-size: 10px;
            color: var(--gray);
            font-weight: 600;
        }

        .tab-item.active { color: #000; }

        /* GRID */
        .catalog-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 15px;
        }

        .product-card {
            background: #fff;
            border-radius: 15px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .img-box { width: 100%; aspect-ratio: 1/1.2; background: #eee; position: relative; }
        .img-box img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    <div class="header">
        <div class="logo">AUNA jewel</div>
    </div>

    <main>
        <div v-if="activeTab === 'catalog'">
            <div class="catalog-grid">
                <div v-for="p in products" :key="p.id" class="product-card" v-show="!p.hidden">
                    <div class="img-box">
                        <img :src="p.images ? p.images[0] : ''">
                    </div>
                    <div style="padding: 12px;">
                        <div style="font-size: 12px; font-weight: 700;">{{ p.name }}</div>
                        <div style="font-size: 14px; font-weight: 800; margin-top: 5px;">{{ p.price }} ₽</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'profile'" style="padding: 20px;">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom:30px;">
                <img :src="user.photo || ''" style="width:60px; height:60px; border-radius:50%; background:#eee">
                <div>
                    <div style="font-weight:800; font-size:18px;">{{ user.first_name }}</div>
                    <div @click="tg.openTelegramLink('https://t.me/opttania')" style="color:blue; font-size:12px; font-weight:700;">Поддержка</div>
                </div>
            </div>

            <div v-if="isAdmin" class="admin-panel">
                <h3 style="margin-top:0; font-weight:800;">АДМИН ПАНЕЛЬ</h3>
                <input class="input-ui" v-model="newP.name" placeholder="Название">
                <textarea class="input-ui" v-model="newP.desc" placeholder="Описание"></textarea>
                <input class="input-ui" v-model="newP.price" type="number" placeholder="Цена">
                <input class="input-ui" v-model="newP.sizes" placeholder="Размеры (через запятую)">
                
                <input type="file" @change="uploadToImgBB" multiple style="margin-bottom:15px;">
                
                <button class="btn-black" @click="saveProduct" :disabled="loading">
                    {{ loading ? 'ЗАГРУЗКА...' : 'ДОБАВИТЬ ТОВАР' }}
                </button>

                <div style="margin-top:30px; border-top:1px solid #ddd; padding-top:20px;">
                    <div v-for="p in products" :key="p.id" style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:12px;">
                        <span>{{ p.name }}</span>
                        <button @click="toggleVisible(p)" :style="{color: p.hidden ? 'red' : 'green'}" style="background:none; border:none; font-weight:800;">
                            {{ p.hidden ? 'СКРЫТ' : 'АКТИВЕН' }}
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <nav class="tab-bar">
        <div class="tab-item" :class="{active: activeTab === 'catalog'}" @click="activeTab = 'catalog'; vibrate()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            <span>Каталог</span>
        </div>
        <div class="tab-item" :class="{active: activeTab === 'profile'}" @click="activeTab = 'profile'; vibrate()">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            <span>Профиль</span>
        </div>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw",
        authDomain: "auna-jewel.firebaseapp.com",
        projectId: "auna-jewel",
        storageBucket: "auna-jewel.appspot.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tg = window.Telegram.WebApp;

    const appVue = Vue.createApp({
        data() {
            return {
                activeTab: 'catalog',
                isAdmin: false,
                adminId: 387881523,
                loading: false,
                user: { first_name: 'Гость', photo: '' },
                products: [],
                newP: { name: '', desc: '', price: '', sizes: '', imgs: [] }
            }
        },
        methods: {
            vibrate() { tg.HapticFeedback.impactOccurred('light'); },
            async uploadToImgBB(e) {
                this.loading = true;
                for (let file of e.target.files) {
                    let fd = new FormData();
                    fd.append("image", file);
                    const r = await fetch("https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f", { method: "POST", body: fd });
                    const d = await r.json();
                    this.newP.imgs.push(d.data.url);
                }
                this.loading = false;
            },
            async saveProduct() {
                if(!this.newP.name) return;
                this.loading = true;
                await addDoc(collection(db, "products"), {
                    ...this.newP,
                    images: this.newP.imgs,
                    createdAt: Date.now(),
                    hidden: false
                });
                this.newP = { name: '', desc: '', price: '', sizes: '', imgs: [] };
                this.loading = false;
                tg.showAlert("Товар добавлен!");
            },
            async toggleVisible(p) {
                await updateDoc(doc(db, "products", p.id), { hidden: !p.hidden });
            }
        },
        mounted() {
            tg.ready();
            if (tg.initDataUnsafe?.user) {
                this.user = { first_name: tg.initDataUnsafe.user.first_name, photo: tg.initDataUnsafe.user.photo_url };
                if (Number(tg.initDataUnsafe.user.id) === Number(this.adminId)) {
                    this.isAdmin = true;
                }
            }

            const q = query(collection(db, "products"), orderBy("createdAt", "desc"));
            onSnapshot(q, (snapshot) => {
                this.products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });
        }
    }).mount('#app');
</script>
</body>
</html>
