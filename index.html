<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARAN</title>
    
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --black: #000000;
            --white: #ffffff;
            --gray: #f8f8f8;
            --border: #e2e2e2;
            --font: 'Montserrat', sans-serif;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; margin: 0; padding: 0; }
        body { font-family: var(--font); background: var(--white); color: var(--black); overflow-x: hidden; }

        /* Защита от белого экрана при загрузке */
        [v-cloak] { display: none; }

        /* Хедер */
        header {
            position: sticky; top: 0; background: var(--white); z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 15px 20px; border-bottom: 1px solid var(--gray);
        }
        .logo { font-weight: 800; letter-spacing: 6px; font-size: 22px; text-transform: uppercase; }

        /* Поиск */
        .search-wrap {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--white); display: flex; align-items: center; padding: 0 20px; z-index: 1010;
        }
        .search-wrap input { flex: 1; border: none; border-bottom: 1px solid var(--black); padding: 10px; font-family: var(--font); }

        /* Бургер */
        .side-drawer {
            position: fixed; top: 0; left: 0; width: 280px; height: 100%;
            background: var(--white); z-index: 2000; padding: 50px 30px;
            transform: translateX(-100%); transition: 0.4s; border-right: 1px solid var(--gray);
        }
        .side-drawer.open { transform: translateX(0); }
        .drawer-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1999; }
        .drawer-link { display: block; font-size: 18px; margin-bottom: 25px; text-decoration: none; color: var(--black); text-transform: uppercase; font-weight: 300; }

        /* Категории */
        .cat-scroll { display: flex; overflow-x: auto; padding: 15px 20px; gap: 8px; scrollbar-width: none; }
        .cat-scroll::-webkit-scrollbar { display: none; }
        .cat-item {
            padding: 12px 22px; border: 1px solid var(--black); background: var(--white);
            font-size: 11px; font-weight: 600; text-transform: uppercase; white-space: nowrap; cursor: pointer;
        }
        .cat-item.active { background: var(--black); color: var(--white); }

        /* Сетка */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1px; background: var(--gray); border-top: 1px solid var(--gray); }
        .card { background: var(--white); position: relative; display: flex; flex-direction: column; padding-bottom: 15px; }
        .card-img-wrap { width: 100%; aspect-ratio: 3/4; overflow: hidden; position: relative; background: #fdfdfd; }
        .card-img-wrap img { width: 100%; height: 100%; object-fit: cover; }
        
        .card-info { padding: 12px; }
        .card-title { font-size: 11px; text-transform: uppercase; height: 28px; overflow: hidden; margin-bottom: 6px; }
        .card-price { font-weight: 800; font-size: 14px; }
        .card-old-price { font-size: 11px; color: #999; text-decoration: line-through; margin-left: 6px; }
        .card-sizes { font-size: 10px; color: #666; margin-top: 8px; }

        /* Full View */
        .full-page { position: fixed; inset: 0; background: var(--white); z-index: 3000; overflow-y: auto; padding-bottom: 100px; }
        .close-full { position: fixed; top: 20px; right: 20px; z-index: 3100; background: var(--white); width: 40px; height: 40px; border: 1px solid var(--black); display: flex; align-items: center; justify-content: center; }
        .slider { width: 100%; height: 65vh; position: relative; background: var(--gray); }
        .slider img { width: 100%; height: 100%; object-fit: cover; }
        .detail-body { padding: 30px 20px; }
        .size-row { display: flex; gap: 8px; margin: 20px 0; }
        .size-box { border: 1px solid var(--black); width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 13px; }
        .size-box.active { background: var(--black); color: var(--white); }

        .sticky-actions { position: fixed; bottom: 25px; left: 20px; right: 20px; display: flex; gap: 10px; z-index: 3010; }
        .btn-black { flex: 2; background: var(--black); color: var(--white); border: none; height: 55px; font-weight: 800; text-transform: uppercase; font-size: 12px; }
        .btn-fav { flex: 1; background: var(--white); color: var(--black); border: 1px solid var(--black); height: 55px; }

        /* Корзина */
        .cart-row { display: flex; gap: 15px; padding: 20px; border-bottom: 1px solid var(--gray); }
        .cart-thumb { width: 70px; height: 90px; object-fit: cover; }
        .qty-btn { width: 30px; height: 30px; border: 1px solid var(--black); background: var(--white); }
        .badge { position: absolute; top: -5px; right: -5px; background: red; color: white; border-radius: 50%; width: 16px; height: 16px; font-size: 9px; display: flex; align-items: center; justify-content: center; }

        /* Карта */
        #map-box { width: 100%; height: 280px; margin: 15px 0; border: 1px solid var(--black); }

        /* Админка */
        .admin-sec { padding: 20px; border-top: 4px solid var(--black); margin-top: 30px; background: #fafafa; }
        .inp { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid var(--border); font-family: var(--font); }
        .admin-card { display: flex; align-items: center; gap: 10px; padding: 10px; border: 1px solid var(--border); margin-bottom: 5px; background: #fff; }

        /* Навигация */
        .nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 75px; background: var(--white); border-top: 1px solid var(--gray); display: flex; justify-content: space-around; align-items: center; z-index: 2500; padding-bottom: 10px; }
        .nav-item { background: none; border: none; display: flex; flex-direction: column; align-items: center; gap: 5px; color: #aaa; text-transform: uppercase; font-size: 9px; font-weight: 600; position: relative; }
        .nav-item.active { color: var(--black); }
        .nav-item svg { width: 22px; height: 22px; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    
    <header>
        <button @click="menu = true; haptic()" style="background:none; border:none;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
        </button>
        <div class="logo">NARAN</div>
        <button @click="searchOpen = true; haptic()" style="background:none; border:none;">
            <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        </button>

        <div v-if="searchOpen" class="search-wrap">
            <input v-model="q" placeholder="Поиск..." autofocus @input="haptic()">
            <button @click="searchOpen = false; q = ''" style="background:none; border:none; margin-left: 10px;">✕</button>
        </div>
    </header>

    <div v-if="menu" class="drawer-overlay" @click="menu = false"></div>
    <div class="side-drawer" :class="{open: menu}">
        <a href="#" class="drawer-link" @click="menu = false">О нас</a>
        <a href="#" class="drawer-link" @click="menu = false">Доставка</a>
        <a href="#" class="drawer-link" @click="menu = false">Возврат</a>
        <div style="margin-top: 100px; font-size: 10px; letter-spacing: 2px;">NARAN PREMIUM STORE</div>
    </div>

    <main style="padding-bottom: 90px;">
        
        <div v-if="tab === 'cat'">
            <div class="cat-scroll">
                <div class="cat-item" :class="{active: curCat === ''}" @click="setCat('')">Все товары</div>
                <div v-for="c in categories" :key="c.id" class="cat-item" :class="{active: curCat === c.name}" @click="setCat(c.name)">{{c.name}}</div>
            </div>

            <div class="grid" v-if="filtered.length > 0">
                <div v-for="p in filtered" :key="p.id" class="card" @click="openP(p)">
                    <div class="card-img-wrap">
                        <img :src="p.images[0]" loading="lazy">
                    </div>
                    <div class="card-info">
                        <div class="card-title">{{p.title}}</div>
                        <div class="card-price">
                            {{p.price}} ₽
                            <span v-if="p.oldPrice" class="card-old-price">{{p.oldPrice}} ₽</span>
                        </div>
                        <div class="card-sizes">{{ formatSizes(p.sizes) }}</div>
                    </div>
                </div>
            </div>
            <div v-else style="text-align: center; padding: 100px 20px; color: #888;">Ничего не найдено</div>
        </div>

        <div v-if="tab === 'fav'" style="padding: 20px;">
            <h2 style="margin-bottom: 20px; font-weight: 800;">ИЗБРАННОЕ</h2>
            <div class="grid" v-if="favs.length > 0">
                <div v-for="p in favProducts" :key="p.id" class="card" @click="openP(p)">
                    <img :src="p.images[0]" class="card-img-wrap">
                    <div class="card-info">
                        <div class="card-title">{{p.title}}</div>
                        <div class="card-price">{{p.price}} ₽</div>
                    </div>
                </div>
            </div>
            <div v-else style="text-align: center; padding: 60px 0; color: #888;">Список пуст</div>
        </div>

        <div v-if="tab === 'cart'" style="padding: 20px;">
            <h2 style="margin-bottom: 20px; font-weight: 800;">КОРЗИНА</h2>
            <div v-if="cart.length > 0">
                <div v-for="(i, idx) in cart" :key="idx" class="cart-row">
                    <img :src="i.images[0]" class="cart-thumb">
                    <div style="flex:1">
                        <div style="font-size: 11px; font-weight: 600;">{{i.title}}</div>
                        <div style="font-size: 10px; color: #888; margin: 4px 0;">РАЗМЕР: {{i.selSize}}</div>
                        <div style="display:flex; align-items:center; gap: 10px; margin-top: 8px;">
                            <button class="qty-btn" @click="changeQty(idx, -1)">-</button>
                            <span>{{i.qty}}</span>
                            <button class="qty-btn" @click="changeQty(idx, 1)">+</button>
                        </div>
                    </div>
                    <div style="text-align:right">
                        <div style="font-weight: 800;">{{i.price * i.qty}} ₽</div>
                        <button @click="remCart(idx)" style="background:none; border:none; color:red; margin-top: 15px;">✕</button>
                    </div>
                </div>

                <div style="margin-top: 40px;">
                    <input v-model="form.phone" class="inp" placeholder="Номер телефона (10-11 цифр)">
                    <div style="display:flex; gap: 5px; margin: 15px 0;">
                        <button v-for="d in ['СДЭК', 'Почта', '5post']" class="cat-item" :class="{active: del === d}" @click="setDel(d)" style="flex:1">{{d}}</button>
                    </div>
                    <div id="map-box" v-show="del"></div>
                    <div v-if="address" style="background:#000; color:#fff; padding: 12px; font-size: 11px; margin-bottom: 20px;">ПВЗ: {{address}}</div>
                    
                    <div style="border-top: 2px solid #000; padding-top: 20px; display:flex; justify-content:space-between; align-items:center;">
                        <div style="font-weight: 800; font-size: 20px;">{{total}} ₽</div>
                        <button class="btn-black" style="flex:none; width: 160px;" @click="order">ЗАКАЗАТЬ</button>
                    </div>
                </div>
            </div>
            <div v-else style="text-align: center; padding: 100px 0; color: #888;">Корзина пуста</div>
        </div>

        <div v-if="tab === 'profile'">
            <div style="padding: 30px 20px; display:flex; align-items:center; gap: 15px; background: #fafafa;">
                <img :src="user.photo_url || 'https://via.placeholder.com/100'" style="width:70px; height:70px; border-radius:50%; border:1px solid #000;">
                <div>
                    <div style="font-weight: 800; font-size: 18px;">{{user.first_name || 'Клиент'}}</div>
                    <button @click="tg.openTelegramLink('https://t.me/opttania')" style="background:none; border:none; text-decoration: underline; font-size: 12px;">Поддержка</button>
                </div>
            </div>

            <div style="padding: 20px;">
                <h3 style="margin-bottom: 15px; font-size: 13px;">МОИ ЗАКАЗЫ</h3>
                <div v-for="o in myOrders" :key="o.id" style="border:1px solid #eee; padding: 15px; margin-bottom: 10px;">
                    <div style="display:flex; justify-content:space-between; font-weight: 800; font-size: 12px;">
                        <span>№{{o.order_id}}</span>
                        <span style="color: green;">{{o.status}}</span>
                    </div>
                    <div style="font-size: 11px; margin-top: 5px;">Итого: {{o.total}} ₽</div>
                </div>
            </div>

            <div v-if="isAdmin" class="admin-sec">
                <h2 style="text-align:center; letter-spacing: 5px; margin-bottom: 20px;">ADMIN</h2>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom: 20px;">
                    <div style="background:#000; color:#fff; padding:15px; text-align:center;">
                        <div style="font-size:10px;">ВЫРУЧКА</div>
                        <div style="font-size:18px; font-weight:800;">{{revenue}} ₽</div>
                    </div>
                    <div style="background:#000; color:#fff; padding:15px; text-align:center;">
                        <div style="font-size:10px;">ЗАКАЗОВ</div>
                        <div style="font-size:18px; font-weight:800;">{{orders.length}}</div>
                    </div>
                </div>

                <div style="background:#fff; padding:15px; border:1px solid #000;">
                    <h4 style="margin-bottom:10px;">{{editId ? 'РЕДАКТИРОВАТЬ' : 'НОВЫЙ ТОВАР'}}</h4>
                    <input v-model="p.title" class="inp" placeholder="Название">
                    <textarea v-model="p.desc" class="inp" placeholder="Описание" rows="3"></textarea>
                    <div style="display:flex; gap:5px;">
                        <input v-model="p.price" type="number" class="inp" placeholder="Цена">
                        <input v-model="p.oldPrice" type="number" class="inp" placeholder="Старая цена">
                    </div>
                    <select v-model="p.category" class="inp">
                        <option value="">Выбрать категорию</option>
                        <option v-for="c in categories" :value="c.name">{{c.name}}</option>
                    </select>
                    <input v-model="p.sizes" class="inp" placeholder="Размеры (через запятую)">
                    
                    <input type="file" multiple @change="upImg" id="f" style="display:none">
                    <button @click="document.getElementById('f').click()" class="btn-black" style="background:#fff; color:#000; border:1px solid #000; margin-bottom: 10px; width:100%;">
                        {{loading ? 'ЗАГРУЗКА...' : 'ВЫБРАТЬ ФОТО'}}
                    </button>

                    <div style="display:flex; gap:5px; overflow-x:auto; margin-bottom: 15px;">
                        <img v-for="img in p.images" :src="img" style="width:60px; height:80px; object-fit:cover;">
                    </div>

                    <button @click="saveP" class="btn-black" style="width:100%">{{editId ? 'СОХРАНИТЬ' : 'ОПУБЛИКОВАТЬ'}}</button>
                    <button v-if="editId" @click="clearP" class="btn-black" style="width:100%; margin-top:5px; background:red;">ОТМЕНА</button>
                </div>

                <div style="margin-top: 30px;">
                    <h4>КАТЕГОРИИ</h4>
                    <div style="display:flex; gap:5px; margin-top:10px;">
                        <input v-model="newCat" class="inp" style="margin-bottom:0" placeholder="Имя категории">
                        <button @click="addCat" class="btn-black" style="width:60px">+</button>
                    </div>
                    <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;">
                        <div v-for="c in categories" class="cat-item" style="padding:5px 10px; font-size:9px;">
                            {{c.name}} <span @click="delCat(c.id)" style="color:red; margin-left:10px">✕</span>
                        </div>
                    </div>
                </div>

                <h4 style="margin-top: 30px;">ТОВАРЫ ({{products.length}})</h4>
                <div v-for="pr in products" class="admin-card">
                    <img :src="pr.images[0]" style="width:40px; height:50px; object-fit:cover;">
                    <div style="flex:1; font-size:11px;">{{pr.title}} - {{pr.price}}₽</div>
                    <button @click="editP(pr)">✏️</button>
                    <button @click="delP(pr.id)" style="color:red">✕</button>
                </div>
            </div>
        </div>
    </main>

    <transition name="fade">
        <div v-if="sel" class="full-page">
            <button class="close-full" @click="sel = null">✕</button>
            <div class="slider">
                <img :src="sel.images[si]" @click="nextI">
                <div style="position:absolute; bottom:20px; width:100%; display:flex; justify-content:center; gap:5px;">
                    <div v-for="(img, idx) in sel.images" :style="{width:'6px', height:'6px', background: idx === si ? '#000' : '#ccc', borderRadius:'50%'}"></div>
                </div>
            </div>
            <div class="detail-body">
                <div style="font-size:10px; color:#999; text-transform:uppercase;">{{sel.category}}</div>
                <h1 style="font-weight:800; font-size:24px; margin: 10px 0;">{{sel.title}}</h1>
                <div style="font-size:20px; margin-bottom:30px;">{{sel.price}} ₽</div>

                <div style="font-weight:800; font-size:12px;">РАЗМЕР:</div>
                <div class="size-row">
                    <div v-for="s in sel.sizes" class="size-box" :class="{active: ss === s}" @click="ss = s; haptic()">{{s}}</div>
                </div>

                <div style="font-weight:800; font-size:12px; margin-bottom:10px;">ОПИСАНИЕ:</div>
                <p style="font-size:14px; line-height:1.6; color:#555; white-space:pre-line;">{{sel.desc}}</p>
            </div>
            <div class="sticky-actions">
                <button class="btn-fav" @click="toggleFav(sel)">
                    <svg width="24" height="24" viewBox="0 0 24 24" :fill="isF(sel.id) ? 'black' : 'none'" stroke="black" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.72-8.72 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
                </button>
                <button class="btn-black" @click="addCart(sel)">В КОРЗИНУ</button>
            </div>
        </div>
    </transition>

    <nav class="nav">
        <button class="nav-item" :class="{active: tab === 'cat'}" @click="tab = 'cat'; haptic()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            Каталог
        </button>
        <button class="nav-item" :class="{active: tab === 'fav'}" @click="tab = 'fav'; haptic()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.72-8.72 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            Избранное
        </button>
        <button class="nav-item" :class="{active: tab === 'cart'}" @click="tab = 'cart'; haptic()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
            Корзина
            <div v-if="cart.length" class="badge">{{cart.length}}</div>
        </button>
        <button class="nav-item" :class="{active: tab === 'profile'}" @click="tab = 'profile'; haptic()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            Профиль
        </button>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const cfg = {
        apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw",
        projectId: "naran-clothes",
        appId: "1:387881523:web:9f8e8b"
    };

    const fb = initializeApp(cfg);
    const db = getFirestore(fb);
    window.db = db;
    window.f = { collection, addDoc, onSnapshot, query, doc, updateDoc, deleteDoc, serverTimestamp };
</script>

<script>
    const tg = window.Telegram.WebApp;
    const { createApp } = Vue;

    createApp({
        data() {
            return {
                tab: 'cat', menu: false, searchOpen: false, q: '', curCat: '',
                products: [], categories: [], orders: [],
                favs: JSON.parse(localStorage.getItem('n_fav') || '[]'),
                cart: JSON.parse(localStorage.getItem('n_cart') || '[]'),
                user: {}, isAdmin: false,
                sel: null, si: 0, ss: '',
                form: { phone: '' }, del: '', address: localStorage.getItem('n_addr') || '',
                map: null, marker: null,
                p: { title: '', desc: '', price: '', oldPrice: '', category: '', sizes: '', images: [] },
                editId: null, loading: false, newCat: ''
            }
        },
        computed: {
            filtered() {
                try {
                    if (!this.products) return [];
                    let res = this.products;
                    if (this.curCat) res = res.filter(x => x.category === this.curCat);
                    if (this.q) res = res.filter(x => x.title.toLowerCase().includes(this.q.toLowerCase()));
                    return res;
                } catch(e) { return []; }
            },
            favProducts() { return this.products.filter(p => this.favs.includes(p.id)); },
            total() { return this.cart.reduce((s, i) => s + (i.price * i.qty), 0); },
            myOrders() { return this.orders.filter(o => o.uid === this.user.id); },
            revenue() { return this.orders.reduce((s, o) => s + (Number(o.total) || 0), 0); }
        },
        methods: {
            haptic() { try { tg.HapticFeedback.impactOccurred('light'); } catch(e){} },
            setCat(c) { try { this.curCat = c; this.haptic(); } catch(e){ this.curCat = ''; } },
            formatSizes(s) { return Array.isArray(s) ? s.join(' ') : s; },
            openP(p) { this.sel = p; this.si = 0; this.ss = p.sizes[0] || ''; this.haptic(); },
            nextI() { this.si = (this.si + 1) % this.sel.images.length; },
            isF(id) { return this.favs.includes(id); },
            toggleFav(p) {
                const i = this.favs.indexOf(p.id);
                if (i > -1) this.favs.splice(i, 1); else this.favs.push(p.id);
                localStorage.setItem('n_fav', JSON.stringify(this.favs));
                this.haptic();
            },
            addCart(p) {
                this.cart.push({ ...p, selSize: this.ss, qty: 1 });
                localStorage.setItem('n_cart', JSON.stringify(this.cart));
                this.sel = null;
                tg.showScanQrPopup({ text: 'Товар в корзине' }); setTimeout(()=>tg.closeScanQrPopup(), 500);
                this.haptic();
            },
            changeQty(i, d) { this.cart[i].qty += d; if (this.cart[i].qty < 1) this.cart.splice(i, 1); localStorage.setItem('n_cart', JSON.stringify(this.cart)); },
            remCart(i) { this.cart.splice(i, 1); localStorage.setItem('n_cart', JSON.stringify(this.cart)); },
            setDel(d) { this.del = d; this.haptic(); setTimeout(() => this.initMap(), 100); },
            initMap() {
                if (this.map) return;
                this.map = new mapgl.Map('map-box', { center: [37.61, 55.75], zoom: 12, key: 'cab82c94-e619-42eb-9814-3361712feaf0' });
                this.map.on('click', e => this.getAddr(e.lngLat));
            },
            async getAddr(c) {
                const r = await fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lon=${c[0]}&lat=${c[1]}&fields=items.address&key=cab82c94-e619-42eb-9814-3361712feaf0`);
                const d = await r.json();
                if (d.result?.items[0]) {
                    this.address = d.result.items[0].address_name || d.result.items[0].full_name;
                    localStorage.setItem('n_addr', this.address);
                    if (this.marker) this.marker.destroy();
                    this.marker = new mapgl.Marker(this.map, { coordinates: c });
                }
            },
            async order() {
                if (this.form.phone.length < 10 || !this.address) return tg.showAlert("Заполните данные!");
                const id = Date.now().toString().slice(-5) + Math.floor(Math.random()*90);
                const order = { order_id: id, uid: this.user.id, phone: this.form.phone, total: this.total, address: this.address, status: 'В обработке', items: this.cart };
                await window.f.addDoc(window.f.collection(window.db, "orders"), order);
                tg.showAlert("Заказ №" + id + " оформлен!");
                this.cart = []; localStorage.removeItem('n_cart'); this.tab = 'profile';
            },
            async upImg(e) {
                this.loading = true;
                try {
                    for (let file of e.target.files) {
                        const fd = new FormData(); fd.append('image', file);
                        const r = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body: fd });
                        const d = await r.json();
                        if (d.success) this.p.images.push(d.data.url);
                    }
                } catch(e) { tg.showAlert("Ошибка ImgBB"); }
                this.loading = false;
            },
            async saveP() {
                const data = { ...this.p, price: Number(this.p.price), sizes: this.p.sizes.split(',').map(s => s.trim()) };
                if (this.editId) await window.f.updateDoc(window.f.doc(window.db, "products", this.editId), data);
                else await window.f.addDoc(window.f.collection(window.db, "products"), data);
                this.clearP();
            },
            editP(pr) { this.editId = pr.id; this.p = { ...pr, sizes: pr.sizes.join(',') }; window.scrollTo(0,0); },
            async delP(id) { if(confirm("Удалить?")) await window.f.deleteDoc(window.f.doc(window.db, "products", id)); },
            clearP() { this.editId = null; this.p = { title: '', desc: '', price: '', oldPrice: '', category: '', sizes: '', images: [] }; },
            async addCat() { await window.f.addDoc(window.f.collection(window.db, "categories"), { name: this.newCat }); this.newCat = ''; },
            async delCat(id) { await window.f.deleteDoc(window.f.doc(window.db, "categories", id)); }
        },
        mounted() {
            tg.ready(); tg.expand();
            if (tg.initDataUnsafe?.user) {
                this.user = tg.initDataUnsafe.user;
                this.isAdmin = [387881523, "387881523"].includes(this.user.id);
                console.log("User ID:", this.user.id, "Is Admin:", this.isAdmin);
            }
            const itv = setInterval(() => {
                if (window.db) {
                    clearInterval(itv);
                    window.f.onSnapshot(window.f.collection(window.db, "products"), s => this.products = s.docs.map(d => ({id: d.id, ...d.data()})));
                    window.f.onSnapshot(window.f.collection(window.db, "categories"), s => this.categories = s.docs.map(d => ({id: d.id, ...d.data()})));
                    window.f.onSnapshot(window.f.collection(window.db, "orders"), s => this.orders = s.docs.map(d => ({id: d.id, ...d.data()})));
                }
            }, 100);
        }
    }).mount('#app');
</script>
</body>
</html>
