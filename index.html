<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARAN</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #ffffff;
            --text: #000000;
            --accent: #000000;
            --gray: #f4f4f4;
            --dark-gray: #777777;
            --red: #ff3b30;
        }

        * { 
            box-sizing: border-box; 
            -webkit-tap-highlight-color: transparent; 
            outline: none; 
            font-family: 'Montserrat', sans-serif;
        }
        
        body { 
            margin: 0; 
            background: var(--bg); 
            color: var(--text); 
            overflow-x: hidden;
            font-size: 14px;
        }

        /* –•–ï–î–ï–† */
        .header {
            position: sticky;
            top: 0;
            z-index: 1000;
            background: #fff;
            padding: 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--gray);
        }

        .brand-name {
            font-weight: 800;
            letter-spacing: 2px;
            text-transform: uppercase;
            font-size: 20px;
        }

        /* –ü–û–ò–°–ö */
        .search-bar {
            padding: 10px 15px;
            background: #fff;
            border-bottom: 1px solid var(--gray);
        }
        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #000;
            background: #fff;
            font-size: 14px;
            border-radius: 0;
        }

        /* –ö–ê–¢–ï–ì–û–†–ò–ò */
        .cat-scroll {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 15px;
            scrollbar-width: none;
        }
        .cat-scroll::-webkit-scrollbar { display: none; }
        .cat-btn {
            padding: 8px 16px;
            border: 1px solid #000;
            background: #fff;
            font-size: 11px;
            text-transform: uppercase;
            font-weight: 700;
            white-space: nowrap;
            cursor: pointer;
        }
        .cat-btn.active {
            background: #000;
            color: #fff;
        }

        /* –°–ï–¢–ö–ê –¢–û–í–ê–†–û–í */
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            padding: 0 15px;
        }
        .card {
            display: flex;
            flex-direction: column;
            position: relative;
            margin-bottom: 20px;
        }
        .card-img-wrap {
            position: relative;
            aspect-ratio: 3/4;
            overflow: hidden;
            background: var(--gray);
        }
        .slider {
            display: flex;
            height: 100%;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
        }
        .slider img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            scroll-snap-align: start;
            flex-shrink: 0;
        }
        .fav-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            z-index: 10;
            padding: 5px;
        }
        .fav-btn svg {
            width: 22px;
            height: 22px;
            stroke: #000;
            stroke-width: 1.5;
            fill: none;
        }
        .fav-btn.active svg {
            fill: #000;
        }

        .card-info {
            padding: 10px 0;
        }
        .card-title {
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 4px;
            text-transform: uppercase;
        }
        .card-price {
            font-weight: 800;
            font-size: 14px;
        }
        .old-price {
            text-decoration: line-through;
            color: #999;
            font-size: 12px;
            margin-left: 5px;
        }

        /* –†–ê–ó–ú–ï–†–´ –í –ö–ê–†–¢–û–ß–ö–ï */
        .size-row {
            display: flex;
            gap: 5px;
            margin: 8px 0;
            flex-wrap: wrap;
        }
        .size-box {
            padding: 5px 8px;
            border: 1px solid #ddd;
            font-size: 10px;
            font-weight: 700;
        }
        .size-box.selected {
            background: #000;
            color: #fff;
            border-color: #000;
        }

        /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (FULL VIEW) */
        .full-view {
            position: fixed;
            inset: 0;
            background: #fff;
            z-index: 2000;
            overflow-y: auto;
            padding-bottom: 50px;
        }
        .close-view {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2100;
            background: #fff;
            border: 1px solid #000;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* –ö–ù–û–ü–ö–ò –î–ï–ô–°–¢–í–ò–Ø */
        .btn-black {
            background: #000;
            color: #fff;
            border: none;
            padding: 15px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
            width: 100%;
            cursor: pointer;
        }
        .btn-outline {
            background: transparent;
            border: 1px solid #000;
            color: #000;
            padding: 15px;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 12px;
            width: 100%;
        }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #fff;
            display: flex;
            border-top: 1px solid var(--gray);
            padding: 10px 0 25px;
            z-index: 1500;
        }
        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            background: none;
            border: none;
            color: #999;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
        }
        .nav-item.active { color: #000; }
        .nav-item svg { width: 20px; height: 20px; }
        .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--red);
            color: #fff;
            font-size: 9px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* –ê–î–ú–ò–ù–ö–ê –ò –ü–†–û–§–ò–õ–¨ */
        .section-title {
            padding: 20px 15px;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 16px;
            border-bottom: 2px solid #000;
            margin-bottom: 15px;
        }
        .input-group { margin-bottom: 15px; padding: 0 15px; }
        .input-group label { display: block; font-size: 10px; font-weight: 700; margin-bottom: 5px; text-transform: uppercase; }
        .input-f { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 0; }

        #map { width: 100%; height: 300px; margin: 15px 0; border: 1px solid #000; }

        /* –°–ü–ò–°–û–ö –ó–ê–ö–ê–ó–û–í */
        .order-card {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 10px;
        }
        .status-tag {
            display: inline-block;
            padding: 4px 8px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            background: #000;
            color: #fff;
        }

        .menu-overlay {
            padding: 20px;
            background: #fff;
            border-bottom: 1px solid #000;
        }
        .menu-link {
            display: block;
            padding: 15px 0;
            font-weight: 700;
            text-transform: uppercase;
            border-bottom: 1px solid #f4f4f4;
        }
    </style>
</head>
<body>

<div id="app">
    <header class="header">
        <button @click="showInfoMenu = !showInfoMenu; v()" style="background:none; border:none;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.5">
                <path d="M3 12h18M3 6h18M3 18h18"/>
            </svg>
        </button>
        <div class="brand-name">NARAN</div>
        <button @click="showSearch = !showSearch; v()" style="background:none; border:none;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.5">
                <circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/>
            </svg>
        </button>
    </header>

    <div v-if="showInfoMenu" class="menu-overlay">
        <div class="menu-link" @click="activeInfo = 'about'">–û –Ω–∞—Å</div>
        <div v-if="activeInfo === 'about'" style="padding: 10px; font-size: 12px;">NARAN ‚Äî –ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π —Ä–æ—Å—Å–∏–π—Å–∫–∏–π –±—Ä–µ–Ω–¥.</div>
        <div class="menu-link" @click="activeInfo = 'returns'">–í–æ–∑–≤—Ä–∞—Ç</div>
        <div v-if="activeInfo === 'returns'" style="padding: 10px; font-size: 12px;">14 –¥–Ω–µ–π –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –±–∏—Ä–æ–∫.</div>
        <div class="menu-link" @click="activeInfo = 'delivery'">–î–æ—Å—Ç–∞–≤–∫–∞</div>
        <div v-if="activeInfo === 'delivery'" style="padding: 10px; font-size: 12px;">–°–î–≠–ö, –ü–æ—á—Ç–∞, 5Post –ø–æ –≤—Å–µ–π –†–§.</div>
    </div>

    <div v-if="showSearch" class="search-bar">
        <input v-model="searchQuery" class="search-input" placeholder="–ü–û–ò–°–ö –¢–û–í–ê–†–ê...">
    </div>

    <main style="padding-bottom: 100px;">
        
        <section v-if="curr === 'catalog'">
            <div class="cat-scroll">
                <button class="cat-btn" :class="{active: curCat === ''}" @click="curCat = ''; v()">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</button>
                <button v-for="c in categories" :key="c" class="cat-btn" :class="{active: curCat === c}" @click="curCat = c; v()">{{c}}</button>
            </div>

            <div class="grid">
                <div v-for="p in filteredProducts" :key="p.id" class="card" @click="openP(p)">
                    <div class="card-img-wrap">
                        <div class="slider" @scroll="e => handleS(e, p)">
                            <img v-for="img in p.images" :src="img" :key="img">
                        </div>
                        <button class="fav-btn" @click.stop="toggleF(p); v()" :class="{active: isF(p)}">
                            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </button>
                    </div>
                    <div class="card-info">
                        <div class="card-title">{{p.title}}</div>
                        <div class="card-price">
                            {{p.price}} ‚ÇΩ
                            <span v-if="p.oldPrice" class="old-price">{{p.oldPrice}} ‚ÇΩ</span>
                        </div>
                        <div class="size-row">
                            <div v-for="s in p.sizes" class="size-box">{{s}}</div>
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="filteredProducts.length === 0" style="text-align:center; padding: 40px;">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        </section>

        <section v-if="curr === 'favs'">
            <div class="section-title">–ò–∑–±—Ä–∞–Ω–Ω–æ–µ</div>
            <div v-if="favItems.length === 0" style="text-align:center; padding: 50px;">–ó–¥–µ—Å—å –±—É–¥—É—Ç –≤–∞—à–∏ –ª—é–±–∏–º—ã–µ –≤–µ—â–∏</div>
            <div class="grid">
                <div v-for="p in favItems" :key="p.id" class="card" @click="openP(p)">
                    <div class="card-img-wrap">
                        <img :src="p.img" style="width:100%; height:100%; object-fit:cover;">
                        <button class="fav-btn active" @click.stop="toggleF(p); v()">
                            <svg viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                        </button>
                    </div>
                    <div class="card-info">
                        <div class="card-title">{{p.title}}</div>
                        <div class="card-price">{{p.price}} ‚ÇΩ</div>
                    </div>
                </div>
            </div>
        </section>

        <section v-if="curr === 'cart'">
            <div class="section-title">–ö–æ—Ä–∑–∏–Ω–∞ ({{cart.length}})</div>
            <div v-if="cart.length === 0" style="text-align:center; padding: 50px;">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
            
            <div v-for="(item, idx) in cart" :key="item.cartId" style="display: flex; gap: 15px; padding: 15px; border-bottom: 1px solid #eee;">
                <img :src="item.img" style="width: 80px; height: 110px; object-fit: cover;">
                <div style="flex: 1;">
                    <div style="font-weight: 700; font-size: 12px;">{{item.title}}</div>
                    <div style="font-size: 11px; margin: 5px 0;">–†–∞–∑–º–µ—Ä: {{item.selS}} | –¶–≤–µ—Ç: {{item.selC || '–ë–∞–∑–æ–≤—ã–π'}}</div>
                    <div style="font-weight: 800;">{{item.price}} ‚ÇΩ</div>
                    <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                        <button @click="item.qty > 1 ? item.qty-- : null; v()" style="border:1px solid #000; background:none; width:25px;">-</button>
                        <span>{{item.qty}}</span>
                        <button @click="item.qty++; v()" style="border:1px solid #000; background:none; width:25px;">+</button>
                    </div>
                </div>
                <button @click="removeC(idx); v()" style="background:none; border:none; font-size: 18px;">‚úï</button>
            </div>

            <div v-if="cart.length > 0" class="input-group" style="margin-top: 20px;">
                <label>–í–∞—à–µ –∏–º—è</label>
                <input v-model="form.name" class="input-f" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                <label style="margin-top: 15px;">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                <input v-model="form.phone" class="input-f" placeholder="79000000000" type="tel">
                
                <label style="margin-top: 15px;">–°–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏</label>
                <div style="display: flex; gap: 5px;">
                    <button v-for="d in ['–°–î–≠–ö', '–ü–æ—á—Ç–∞', '5post']" @click="deliv = d; initMap(); v()" :class="['cat-btn', deliv === d ? 'active' : '']" style="flex:1;">{{d}}</button>
                </div>

                <div v-show="deliv">
                    <div id="map"></div>
                    <p style="font-size: 11px; font-weight: 700;">üìç {{address || '–í—ã–±–µ—Ä–∏—Ç–µ –ü–í–ó –Ω–∞ –∫–∞—Ä—Ç–µ'}}</p>
                </div>

                <button class="btn-black" @click="sendOrder" :disabled="!isValid" style="margin-top: 20px;">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑: {{total}} ‚ÇΩ</button>
            </div>
        </section>

        <section v-if="curr === 'profile'">
            <div style="text-align: center; padding: 30px 15px; background: #000; color: #fff;">
                <img :src="user.photo || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" style="width: 80px; height: 80px; border-radius: 50%; border: 2px solid #fff;">
                <h2 style="margin: 10px 0 5px;">{{user.first_name}}</h2>
                <button @click="openTG" style="background:#fff; color:#000; border:none; padding:5px 15px; font-size:10px; font-weight:800;">–ü–û–î–î–ï–†–ñ–ö–ê</button>
            </div>

            <div class="section-title">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</div>
            <div v-for="o in myOrders" :key="o.id" class="order-card">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div>
                        <div style="font-weight: 800; font-size: 12px;">–ó–ê–ö–ê–ó ‚Ññ{{o.order_id}}</div>
                        <div style="font-size: 10px; color: #666;">{{o.date}}</div>
                    </div>
                    <div class="status-tag">{{o.status || '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ'}}</div>
                </div>
                <div style="margin-top: 10px; font-size: 11px;">–°—É–º–º–∞: {{o.total}} ‚ÇΩ</div>
            </div>

            <div v-if="isAdmin" style="margin-top: 40px; border-top: 5px solid #000;">
                <div class="section-title">–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ üîê</div>
                
                <div class="input-group">
                    <label>–î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</label>
                    <input v-model="newP.title" class="input-f" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
                    <textarea v-model="newP.desc" class="input-f" style="margin-top:5px;" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></textarea>
                    <div style="display: flex; gap: 5px; margin-top: 5px;">
                        <input v-model.number="newP.price" class="input-f" placeholder="–¶–µ–Ω–∞">
                        <input v-model.number="newP.oldPrice" class="input-f" placeholder="–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞">
                    </div>
                    <select v-model="newP.category" class="input-f" style="margin-top:5px;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</option>
                        <option v-for="c in categories" :value="c">{{c}}</option>
                    </select>
                    <input v-model="newP.sizesInput" class="input-f" style="margin-top:5px;" placeholder="–†–∞–∑–º–µ—Ä—ã (42, 44, 46)">
                    <input type="file" @change="uploadFiles" multiple class="input-f" style="margin-top:5px;">
                    <button class="btn-black" @click="saveP" :disabled="loading" style="margin-top:10px;">{{loading ? '–ó–ê–ì–†–£–ó–ö–ê...' : '–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨'}}</button>
                </div>

                <div class="section-title">–£–ü–†–ê–í–õ–ï–ù–ò–ï ({{products.length}})</div>
                <div v-for="p in products" :key="p.id" style="padding: 10px 15px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px;">
                    <img :src="p.img" style="width: 40px; height: 50px; object-fit: cover;">
                    <div style="flex: 1;">
                        <div style="font-size: 11px; font-weight: 700;">{{p.title}}</div>
                        <div style="font-size: 10px;">{{p.price}} ‚ÇΩ</div>
                    </div>
                    <button @click="toggleHide(p)" :style="{background: p.hidden ? 'red' : 'green'}" style="color:#fff; border:none; padding:5px; font-size:9px;">{{p.hidden ? '–°–ö–†–´–¢' : '–ê–ö–¢–ò–í'}}</button>
                    <button @click="delP(p.id)" style="background:#000; color:#fff; border:none; padding:5px; font-size:9px;">–£–î–ê–õ–ò–¢–¨</button>
                </div>
            </div>
        </section>
    </main>

    <div v-if="selP" class="full-view">
        <button class="close-view" @click="selP = null; v()">‚úï</button>
        <div class="slider" style="aspect-ratio: 3/4; background: #f4f4f4;">
            <img v-for="img in selP.images" :src="img" :key="img">
        </div>
        <div style="padding: 20px;">
            <div class="brand-name" style="font-size: 14px; margin-bottom: 5px;">NARAN</div>
            <h2 style="font-size: 20px; margin: 0; text-transform: uppercase;">{{selP.title}}</h2>
            <div style="font-size: 22px; font-weight: 800; margin: 15px 0;">
                {{selP.price}} ‚ÇΩ
                <span v-if="selP.oldPrice" class="old-price" style="font-size: 16px;">{{selP.oldPrice}} ‚ÇΩ</span>
            </div>
            
            <p style="font-size: 13px; line-height: 1.6; color: #444;">{{selP.desc}}</p>
            
            <div style="margin: 20px 0;">
                <label style="font-size: 10px; font-weight: 700; text-transform: uppercase;">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä:</label>
                <div class="size-row" style="margin-top: 10px;">
                    <button v-for="s in selP.sizes" @click="selP.selS = s; v()" :class="['cat-btn', selP.selS === s ? 'active' : '']">{{s}}</button>
                </div>
            </div>

            <div style="display: flex; gap: 10px;">
                <button class="btn-outline" @click="toggleF(selP); v()" style="flex: 1;">–í –ò–ó–ë–†–ê–ù–ù–û–ï</button>
                <button class="btn-black" @click="addC(selP); v()" style="flex: 2;">–í –ö–û–†–ó–ò–ù–£</button>
            </div>
        </div>
    </div>

    <nav class="nav">
        <button @click="curr = 'catalog'; v()" class="nav-item" :class="{active: curr === 'catalog'}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
            –ö–∞—Ç–∞–ª–æ–≥
        </button>
        <button @click="curr = 'favs'; v()" class="nav-item" :class="{active: curr === 'favs'}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l8.78-8.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg>
            –ò–∑–±—Ä–∞–Ω–Ω–æ–µ
        </button>
        <button @click="curr = 'cart'; v()" class="nav-item" :class="{active: curr === 'cart'}">
            <div style="position: relative;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"/><path d="M3 6h18"/><path d="M16 10a4 4 0 0 1-8 0"/></svg>
                <span v-if="cart.length > 0" class="badge">{{cart.length}}</span>
            </div>
            –ö–æ—Ä–∑–∏–Ω–∞
        </button>
        <button @click="curr = 'profile'; v()" class="nav-item" :class="{active: curr === 'profile'}">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
            –ü—Ä–æ—Ñ–∏–ª—å
        </button>
    </nav>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw",
    authDomain: "naran-80077.firebaseapp.com",
    projectId: "naran-80077",
    storageBucket: "naran-80077.firebasestorage.app",
    messagingSenderId: "901156477154",
    appId: "IG-PR8PLCMF3C"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const tg = window.Telegram.WebApp;
  const { createApp } = Vue;

  createApp({
    data() {
      return {
        curr: 'catalog',
        curCat: '',
        searchQuery: '',
        showSearch: false,
        showInfoMenu: false,
        activeInfo: null,
        loading: false,
        isAdmin: false,
        adminId: 387881523,
        user: { id: 0, first_name: '–ì–æ—Å—Ç—å', photo: '' },
        products: [],
        categories: ['–ü–∏–¥–∂–∞–∫–∏', '–°–≤–∏—Ç–µ—Ä—ã', '–ö–∞—Ä–¥–∏–≥–∞–Ω—ã', '–ö–æ—Å—Ç—é–º—ã', '–õ–æ–Ω–≥—Å–ª–∏–≤—ã', '–§—É—Ç–±–æ–ª–∫–∏', '–ö–æ—Ä—Å–µ—Ç—ã', '–ö—É—Ä—Ç–∫–∏', '–≠–∫–æ—à—É–±—ã'],
        cart: JSON.parse(localStorage.getItem('naran_cart')) || [],
        favs: JSON.parse(localStorage.getItem('naran_favs')) || [],
        orders: [],
        selP: null,
        deliv: '',
        address: localStorage.getItem('naran_addr') || '',
        map: null,
        form: { name: '', phone: localStorage.getItem('naran_phone') || '' },
        newP: { title: '', price: '', oldPrice: '', desc: '', category: '', sizesInput: '42, 44, 46', images: [] }
      }
    },

    computed: {
      filteredProducts() {
        try {
          if (!this.products) return [];
          return this.products.filter(p => {
            const matchCat = this.curCat === '' || p.category === this.curCat;
            const matchSearch = p.title.toLowerCase().includes(this.searchQuery.toLowerCase());
            const matchVis = this.isAdmin || !p.hidden;
            return matchCat && matchSearch && matchVis;
          });
        } catch(e) { return []; }
      },
      favItems() {
        return this.products.filter(p => this.favs.includes(p.id));
      },
      myOrders() {
        return this.orders.filter(o => o.userId === this.user.id);
      },
      total() {
        return this.cart.reduce((s, i) => s + (i.price * i.qty), 0);
      },
      isValid() {
        return this.form.name.length > 1 && this.form.phone.length >= 10 && this.address;
      }
    },

    methods: {
      v() { tg.HapticFeedback.impactOccurred('medium'); },
      
      handleS(e, p) {
        p.aIdx = Math.round(e.target.scrollLeft / e.target.offsetWidth);
      },

      openP(p) { this.selP = { ...p, selS: p.sizes[0], qty: 1 }; },

      toggleF(p) {
        const idx = this.favs.indexOf(p.id);
        if (idx > -1) this.favs.splice(idx, 1);
        else this.favs.push(p.id);
        localStorage.setItem('naran_favs', JSON.stringify(this.favs));
      },

      isF(p) { return this.favs.includes(p.id); },

      addC(p) {
        const item = { ...p, cartId: Date.now() };
        this.cart.push(item);
        localStorage.setItem('naran_cart', JSON.stringify(this.cart));
        this.selP = null;
      },

      removeC(idx) {
        this.cart.splice(idx, 1);
        localStorage.setItem('naran_cart', JSON.stringify(this.cart));
      },

      openTG() { tg.openTelegramLink('https://t.me/opttania'); },

      async uploadFiles(e) {
        const files = e.target.files;
        this.loading = true;
        for (let file of files) {
          const formData = new FormData();
          formData.append('image', file);
          try {
            const res = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body: formData });
            const data = await res.json();
            if (data.success) this.newP.images.push(data.data.url);
          } catch(e) { tg.showAlert('–û—à–∏–±–∫–∞ ImgBB'); }
        }
        this.loading = false;
      },

      async saveP() {
        if (!this.newP.title || this.newP.images.length === 0) return tg.showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ');
        this.loading = true;
        try {
          await addDoc(collection(db, "products"), {
            ...this.newP,
            img: this.newP.images[0],
            sizes: this.newP.sizesInput.split(',').map(s => s.trim()),
            hidden: false,
            createdAt: serverTimestamp()
          });
          this.newP = { title: '', price: '', oldPrice: '', desc: '', category: '', sizesInput: '42, 44, 46', images: [] };
          tg.showAlert('–£—Å–ø–µ—à–Ω–æ');
        } catch(e) { tg.showAlert('–û—à–∏–±–∫–∞ –ë–î'); }
        this.loading = false;
      },

      async toggleHide(p) {
        await updateDoc(doc(db, "products", p.id), { hidden: !p.hidden });
      },

      async delP(id) {
        if (confirm('–£–¥–∞–ª–∏—Ç—å?')) await deleteDoc(doc(db, "products", id));
      },

      initMap() {
        this.$nextTick(() => {
          setTimeout(() => {
            if (this.map) this.map.destroy();
            this.map = new mapgl.Map('map', {
              center: [37.6175, 55.7558],
              zoom: 12,
              key: 'cab82c94-e619-42eb-9814-3361712feaf0'
            });
            this.map.on('click', (e) => {
              const [lon, lat] = e.lngLat;
              fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lat=${lat}&lon=${lon}&fields=items.address&key=cab82c94-e619-42eb-9814-3361712feaf0`)
                .then(r => r.json()).then(d => {
                  if (d.result?.items[0]) {
                    this.address = d.result.items[0].address_name || d.result.items[0].name;
                    localStorage.setItem('naran_addr', this.address);
                  }
                });
            });
          }, 300);
        });
      },

      async sendOrder() {
        const orderId = `${new Date().getDate()}${new Date().getMonth()+1}-${Math.floor(10000 + Math.random() * 90000)}`;
        const orderData = {
          order_id: orderId,
          userId: this.user.id,
          userName: this.user.first_name,
          userPhone: this.form.phone,
          cart: this.cart,
          total: this.total,
          delivery: this.deliv,
          address: this.address,
          status: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
          date: new Date().toLocaleString()
        };

        try {
          await addDoc(collection(db, "orders"), orderData);
          tg.sendData(JSON.stringify(orderData));
          this.cart = [];
          localStorage.removeItem('naran_cart');
          localStorage.setItem('naran_phone', this.form.phone);
          tg.showAlert(`–ó–∞–∫–∞–∑ ‚Ññ${orderId} –æ—Ñ–æ—Ä–º–ª–µ–Ω!`);
          this.curr = 'profile';
        } catch(e) { tg.showAlert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏'); }
      }
    },

    mounted() {
      tg.ready();
      tg.expand();
      if (tg.initDataUnsafe?.user) {
        this.user = tg.initDataUnsafe.user;
        this.isAdmin = Number(this.user.id) === this.adminId;
      }

      onSnapshot(query(collection(db, "products"), orderBy("createdAt", "desc")), (s) => {
        this.products = s.docs.map(d => ({ id: d.id, ...d.data(), aIdx: 0 }));
      });

      onSnapshot(collection(db, "orders"), (s) => {
        this.orders = s.docs.map(d => ({ id: d.id, ...d.data() }));
      });
    }
  }).mount('#app');
</script>
</body>
</html>
