
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARAN PREMIUM</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg: #ffffff;
            --dark: #000000;
            --gray: #8e8e93;
            --light: #f2f2f7;
            --accent: #000000;
            --red: #ff3b30;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { 
            margin: 0; 
            background: var(--bg); 
            font-family: 'Montserrat', sans-serif; 
            color: var(--dark); 
            overflow-x: hidden; 
        }

        /* Header & Search */
        .header { 
            background: #fff; padding: 15px; display: flex; align-items: center; justify-content: space-between; 
            position: sticky; top: 0; z-index: 100; border-bottom: 1px solid #eeeeee;
        }
        .brand-name { font-size: 22px; font-weight: 800; letter-spacing: 2px; text-transform: uppercase; }
        .search-container { padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; }
        .search-input { 
            width: 100%; padding: 12px; border: 1px solid #000; border-radius: 2px; 
            font-family: inherit; font-size: 14px; text-transform: uppercase;
        }

        .container { padding: 15px; padding-bottom: 100px; min-height: 100vh; }

        /* Categories */
        .cat-row { 
            display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; 
            padding: 5px 0; scrollbar-width: none; 
        }
        .cat-row::-webkit-scrollbar { display: none; }
        .cat-tab {
    color: #000000 !important; /* –¢–µ–∫—Å—Ç –≤—Å–µ–≥–¥–∞ —á–µ—Ä–Ω—ã–π –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é */
    cursor: pointer !important; /* –î–µ–ª–∞–µ—Ç –∫–Ω–æ–ø–∫—É –∞–∫—Ç–∏–≤–Ω–æ–π –¥–ª—è –∫–ª–∏–∫–∞ */
    transition: all 0.1s ease;
    user-select: none;
    touch-action: manipulation; /* –£–ª—É—á—à–∞–µ—Ç –æ—Ç–∫–ª–∏–∫ –Ω–∞ —Å–º–∞—Ä—Ç—Ñ–æ–Ω–∞—Ö */
}

.cat-tab:active {
    background: #000000 !important;
    transform: scale(0.95); /* –≠—Ñ—Ñ–µ–∫—Ç –ø—Ä–æ—Å–µ–¥–∞–Ω–∏—è –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ */
    opacity: 0.7;
}

        /* –ù–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫ */
.fav-overlay { 
    position: absolute; top: 8px; right: 8px; z-index: 10; 
    background: rgba(255,255,255,0.7); border-radius: 50%; 
    width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
    border: none; cursor: pointer; backdrop-filter: blur(2px);
}
.card-sizes { 
    display: flex; gap: 5px; overflow-x: auto; padding: 5px 0; 
    scrollbar-width: none; margin-bottom: 8px;
}
.size-chip { 
    font-size: 9px; font-weight: 700; padding: 4px 8px; 
    border: 1px solid #ddd; border-radius: 2px; white-space: nowrap;
}
.size-chip.active { background: #000; color: #fff; border-color: #000; }

        /* Grid */
        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .card { background: #fff; border: 1px solid #f0f0f0; position: relative; overflow: hidden; }
        
        /* Slider */
        .slider-wrapper { position: relative; width: 100%; aspect-ratio: 3/4; overflow: hidden; background: #f9f9f9; }
        .slider-inner { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; height: 100%; }
        .slider-inner::-webkit-scrollbar { display: none; }
        .slider-inner img { width: 100%; height: 100%; object-fit: cover; scroll-snap-align: start; flex-shrink: 0; }
        
        .dots { position: absolute; bottom: 8px; width: 100%; display: flex; justify-content: center; gap: 4px; }
        .dot { width: 4px; height: 4px; border-radius: 50%; background: rgba(0,0,0,0.2); }
        .dot.active { background: #000; width: 10px; border-radius: 2px; }

        .card-info { padding: 12px; }
        .card-title { font-size: 11px; font-weight: 600; height: 28px; overflow: hidden; margin-bottom: 5px; text-transform: uppercase; }
        .price-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
        .price { font-weight: 800; font-size: 14px; }
        .old-price { font-size: 11px; color: var(--gray); text-decoration: line-through; }
        .sale-badge { background: #000; color: #fff; font-size: 9px; padding: 2px 4px; font-weight: 800; }

        /* Buttons */
        .btn-row { display: flex; gap: 5px; }
        .btn-black { background: #000; color: #fff; border: none; padding: 12px; font-weight: 700; font-size: 11px; text-transform: uppercase; flex: 1; cursor: pointer; border-radius: 2px; }
        .btn-fav { background: #fff; border: 1px solid #000; padding: 10px; width: 40px; display: flex; align-items: center; justify-content: center; border-radius: 2px; }

        /* Modal Product View */
        .modal { position: fixed; inset: 0; background: #fff; z-index: 2000; overflow-y: auto; padding-bottom: 50px; }
        .close-modal { position: fixed; top: 15px; right: 15px; z-index: 2100; background: #fff; border: 1px solid #000; width: 35px; height: 35px; display: flex; align-items: center; justify-content: center; font-weight: 800; }
        
        .size-grid { display: flex; gap: 10px; margin: 15px 0; }
        .size-btn { flex: 1; padding: 12px; border: 1px solid #eee; background: #fff; font-size: 12px; font-weight: 700; border-radius: 2px; }
        .size-btn.active, .deliv-btn.active { border-color: #000; background: #000; color: #fff; }
    

        /* Bottom Nav */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff; 
            display: flex; justify-content: space-around; padding: 10px 0 25px; 
            border-top: 1px solid #eee; z-index: 1000; 
        }
        .nav-item { 
            border: none; background: none; color: #a1a1a1; display: flex; 
            flex-direction: column; align-items: center; font-size: 9px; font-weight: 700; 
            gap: 4px; text-transform: uppercase; position: relative;
        }
        .nav-item.active { color: #000; }
        .nav-item svg { width: 20px; height: 20px; }
        .badge { 
            position: absolute; top: -5px; right: -8px; background: var(--red); 
            color: #fff; font-size: 9px; padding: 2px 5px; border-radius: 10px; font-weight: 800;
        }

        /* Cart & Order Form */
        .cart-item { display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid #eee; }
        .cart-img { width: 80px; aspect-ratio: 3/4; object-fit: cover; }
        .qty-controls { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .qty-btn { width: 25px; height: 25px; border: 1px solid #000; background: none; font-weight: 800; }

        #map { width: 100%; height: 300px; background: #f0f0f0; margin: 15px 0; border: 1px solid #000; }
        .delivery-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin: 15px 0; }

        /* Admin Styles */
        .admin-section { background: #f9f9f9; padding: 15px; border-radius: 2px; margin-top: 20px; border: 1px solid #eee; }
        .field { margin-bottom: 15px; }
        .field label { display: block; font-size: 10px; font-weight: 800; margin-bottom: 5px; text-transform: uppercase; }
        .input-admin { width: 100%; padding: 12px; border: 1px solid #ddd; font-family: inherit; font-size: 13px; border-radius: 2px; }
        
        .order-card { background: #fff; border: 1px solid #eee; padding: 15px; margin-bottom: 10px; color: #000; }
        .status-badge { display: inline-block; padding: 4px 8px; font-size: 9px; font-weight: 800; text-transform: uppercase; margin-top: 5px; }
        .status-ready { background: #e8f5e9; color: #2e7d32; }
        .status-process { background: #fff3e0; color: #ef6c00; }

        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak>
    
    <header class="header">
        <button @click="burgerOpen = !burgerOpen; vib()" style="border:none; background:none;">
            <svg viewBox="0 0 24 24" width="24" height="24" stroke="#000000" stroke-width="2" fill="none"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <div class="brand-name">NARAN</div>
        <div class="header-side" style="justify-content: flex-end;">
        <button v-if="tab === 'catalog'" @click="searchMode = !searchMode; vib()" style="border:none; background:none; padding:0;">
            <svg viewBox="0 0 24 24" width="22" height="22" stroke="#000000" stroke-width="2.5" fill="none"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </button>
    </div>
    </header>

    <div v-if="searchMode && tab === 'catalog'" class="search-container">
    <input v-model="searchQuery" class="search-input" placeholder="–ü–û–ò–°–ö –¢–û–í–ê–†–ê..." @input="vib()">
</div>

    <div v-if="burgerOpen" class="modal" style="padding: 40px; z-index: 3000; overflow-y: auto;">
    <button class="close-modal" @click="burgerOpen = false">‚úï</button>
    <div class="brand-name" style="margin-bottom: 40px;">NARAN</div>
    
    <div style="display: flex; flex-direction: column; gap: 10px;">
        
        <div class="menu-accordion">
            <div class="menu-item" @click="activeInfo = activeInfo === 'about' ? null : 'about'; haptic()" 
                 style="display: flex; justify-content: space-between; font-weight: 700; padding: 15px 0; border-bottom: 1px solid #eee;">
                <span>–û –ù–ê–°</span>
                <span>{{ activeInfo === 'about' ? '‚àí' : '+' }}</span>
            </div>
            <div v-if="activeInfo === 'about'" style="padding: 15px 0; font-size: 13px; line-height: 1.6; color: #666; animation: fadeIn 0.3s ease;">
                NARAN ‚Äî —ç—Ç–æ –ø—Ä–µ–º–∏–∞–ª—å–Ω–∞—è —ç—Å—Ç–µ—Ç–∏–∫–∞, –≤–æ–ø–ª–æ—â–µ–Ω–Ω–∞—è –≤ –∫–∞–∂–¥–æ–π –¥–µ—Ç–∞–ª–∏. –ú—ã —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –º–∏–Ω–∏–º–∞–ª–∏–∑–º–µ, –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –º–∞—Ç–µ—Ä–∏–∞–ª–∞—Ö –∏ –∏–¥–µ–∞–ª—å–Ω–æ–π –ø–æ—Å–∞–¥–∫–µ.
                <p style="margin-top:10px;">–ü–æ –≤–æ–ø—Ä–æ—Å–∞–º: <b>@opttania</b></p>
            </div>
        </div>

        <div class="menu-accordion">
            <div class="menu-item" @click="activeInfo = activeInfo === 'delivery' ? null : 'delivery'; haptic()" 
                 style="display: flex; justify-content: space-between; font-weight: 700; padding: 15px 0; border-bottom: 1px solid #eee;">
                <span>–î–û–°–¢–ê–í–ö–ê</span>
                <span>{{ activeInfo === 'delivery' ? '‚àí' : '+' }}</span>
            </div>
            <div v-if="activeInfo === 'delivery'" style="padding: 15px 0; font-size: 13px; line-height: 1.6; color: #666; animation: fadeIn 0.3s ease;">
                –î–æ—Å—Ç–∞–≤–∫–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –°–î–≠–ö –∏–ª–∏ –ü–æ—á—Ç–æ–π –†–æ—Å—Å–∏–∏. <br>
                <b>–ë–µ—Å–ø–ª–∞—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞</b> –ø—Ä–∏ –∑–∞–∫–∞–∑–µ –æ—Ç 15 000 ‚ÇΩ.
            </div>
        </div>

        <div class="menu-accordion">
            <div class="menu-item" @click="activeInfo = activeInfo === 'return' ? null : 'return'; haptic()" 
                 style="display: flex; justify-content: space-between; font-weight: 700; padding: 15px 0; border-bottom: 1px solid #eee;">
                <span>–í–û–ó–í–†–ê–¢</span>
                <span>{{ activeInfo === 'return' ? '‚àí' : '+' }}</span>
            </div>
            <div v-if="activeInfo === 'return'" style="padding: 15px 0; font-size: 13px; line-height: 1.6; color: #666; animation: fadeIn 0.3s ease;">
                –í–æ–∑–≤—Ä–∞—Ç –≤–æ–∑–º–æ–∂–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 7 –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤—Å–µ—Ö –±–∏—Ä–æ–∫ –∏ —Ç–æ–≤–∞—Ä–Ω–æ–≥–æ –≤–∏–¥–∞.
            </div>
        </div>

    </div>
</div>

    <main class="container">
    <div v-if="tab === 'catalog'">
        <div class="cat-row">
            <button @click="setCategory('')" :class="['cat-tab', currentCat === '' ? 'active' : '']">–í–°–ï –¢–û–í–ê–†–´</button>
            <button v-for="cat in categories" :key="cat.id" @click="setCategory(cat.name)" :class="['cat-tab', currentCat === cat.name ? 'active' : '']">
                {{cat.name}}
            </button>
        </div>

        <div class="products-grid">
            <div v-for="p in filteredProducts" :key="p.id" class="card">
                <div class="slider-wrapper">
                    <button class="fav-overlay" @click.stop="toggleFav(p)">
                        <svg :fill="isFav(p) ? '#ff3b30' : 'none'" viewBox="0 0 24 24" width="20" height="20" :stroke="isFav(p) ? '#ff3b30' : '#000'" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </button>
                    <div class="slider-inner" @scroll="e => handleScroll(e, p)" @click="openProduct(p)">
                        <img v-for="img in p.images" :key="img" :src="img" loading="lazy">
                    </div>
                    <div class="dots" v-if="p.images && p.images.length > 1">
                        <span v-for="(img, i) in p.images" :key="i" :class="['dot', {active: i === (p.aIdx || 0)}]"></span>
                    </div>
                    <div v-if="p.oldPrice" class="sale-badge" style="position:absolute; top:10px; left:10px;">SALE</div>
                </div>

                <div class="card-info">
                    <div class="card-title" @click="openProduct(p)">{{p.title}}</div>
                    <div class="price-row" @click="openProduct(p)">
                        <span class="price">{{p.price}} ‚ÇΩ</span>
                        <span v-if="p.oldPrice" class="old-price">{{p.oldPrice}} ‚ÇΩ</span>
                    </div>
                    
                    <div class="card-sizes">
    <div v-for="s in (String(p.sizes || '').split(','))" 
         v-if="p.sizes"
         :key="s" 
         @click="p.tempSize = s.trim(); vib()" 
         :class="['size-chip', {active: (p.tempSize || String(p.sizes).split(',')[0].trim()) === s.trim()}]">
        {{s.trim()}}
    </div>
</div>

<div class="product-rating" @click="openProduct(p)" style="display: flex; align-items: center; gap: 6px; margin: 8px 0 12px 2px;">
        <div style="display: flex; align-items: center; background: #fff9e6; padding: 2px 8px; border-radius: 8px; border: 1px solid #ffecb3;">
            <span style="color: #ffb400; font-size: 14px; margin-right: 4px;">‚òÖ</span>
            <span style="font-weight: 800; font-size: 13px; color: #d4a017;">
                {{ getProductrating(p.id) }} 
            </span>
        </div>
        <span style="color: var(--gray); font-size: 11px; font-weight: 600;">
            {{ allReviews.filter(r => r.productId === p.id).length }} –æ—Ç–∑—ã–≤–æ–≤
        </span>
    </div>
                    <button class="btn-black" style="width: 100%;" @click.stop="quickAddToCart(p)">
                        –í –ö–û–†–ó–ò–ù–£
                    </button>
                </div>
            </div>
        </div>
        <div v-if="filteredProducts.length === 0" style="text-align:center; padding: 50px; font-weight: 700;">–¢–û–í–ê–†–û–í –ù–ï –ù–ê–ô–î–ï–ù–û</div>
    </div>

    <div v-if="tab === 'favs'">
        <h2 class="brand-name" style="font-size: 16px; margin-bottom: 20px;">–ò–ó–ë–†–ê–ù–ù–û–ï</h2>
        <div v-if="favList.length === 0" style="text-align:center; padding: 50px;">–ó–¥–µ—Å—å –ø–æ–∫–∞ –ø—É—Å—Ç–æ</div>
        
        <div class="products-grid">
            <div v-for="p in favList" :key="p.id" class="card">
                <div class="slider-wrapper">
                    <button class="fav-overlay" @click.stop="toggleFav(p)">
                        <svg :fill="isFav(p) ? '#ff3b30' : 'none'" viewBox="0 0 24 24" width="20" height="20" :stroke="isFav(p) ? '#ff3b30' : '#000'" stroke-width="2">
                            <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                        </svg>
                    </button>
                    <div class="slider-inner" @scroll="e => handleScroll(e, p)" @click="openProduct(p)">
                        <img v-for="img in p.images" :key="img" :src="img" loading="lazy">
                    </div>
                    <div class="dots" v-if="p.images.length > 1">
                        <span v-for="(img, i) in p.images" :key="i" :class="['dot', {active: i === (p.aIdx || 0)}]"></span>
                    </div>
                </div>

                <div class="card-info">
                    <div class="card-title" @click="openProduct(p)">{{p.title}}</div>
                    <div class="price-row" @click="openProduct(p)">
                        <span class="price">{{p.price}} ‚ÇΩ</span>
                    </div>
                    <div class="card-sizes">
    <div v-for="s in (String(p.sizes || '').split(','))" 
         v-if="p.sizes"
         :key="s"
         @click="p.tempSize = s.trim(); vib()"
         :class="['size-chip', {active: (p.tempSize || String(p.sizes).split(',')[0].trim()) === s.trim()}]">
        {{s.trim()}}
    </div>
</div>
                    <button class="btn-black" style="width: 100%; margin-top: 5px;" @click.stop="quickAddToCart(p)">
                        –í –ö–û–†–ó–ò–ù–£
                    </button>
                </div> </div> </div> </div> <div v-if="tab === 'cart'">
        <h2 class="brand-name" style="font-size: 16px; margin-bottom: 20px;">–ö–û–†–ó–ò–ù–ê</h2>
        <div v-if="cart.length === 0" style="text-align:center; padding: 50px;">–í–ê–®–ê –ö–û–†–ó–ò–ù–ê –ü–£–°–¢–ê</div>
        <div v-else>
            <div v-for="item in cart" :key="item.cartId" class="cart-item">
                <img :src="item.images[0]" class="cart-img" @click="openProduct(item)" style="cursor:pointer;">
                <div style="flex:1;">
                    <div @click="openProduct(item)" style="cursor:pointer;">
                        <div style="font-weight:700; font-size:12px; text-transform:uppercase;">{{item.title}}</div>
                        <div style="font-size:10px; color:gray; margin: 4px 0;">–†–ê–ó–ú–ï–†: {{item.selSize}} | –¶–í–ï–¢: {{item.selColor}}</div>
                        <div style="font-weight:800;">{{item.price}} ‚ÇΩ</div>
                    </div>
                    <div class="qty-controls">
                        <button class="qty-btn" @click="changeQty(item, -1)">-</button>
                        <span style="font-weight:700;">{{item.qty}}</span>
                        <button class="qty-btn" @click="changeQty(item, 1)">+</button>
                    </div>
                </div>
                <button @click="removeFromCart(item.cartId)" style="border:none; background:none; font-size: 18px;">‚úï</button>
            </div>

            <div style="margin-top: 30px;">
                <div class="field">
                    <label>–í–ê–®–ï –ò–ú–Ø</label>
                    <input v-model="form.name" class="input-admin" placeholder="–ò–ú–Ø">
                </div>
                <div class="field">
                    <label>–¢–ï–õ–ï–§–û–ù (10-11 –¶–ò–§–†)</label>
                    <input v-model="form.phone" class="input-admin" type="tel" placeholder="89000000000">
                </div>

                <label style="font-size:10px; font-weight:800;">–°–ü–û–°–û–ë –î–û–°–¢–ê–í–ö–ò</label>
                <div class="delivery-grid">
                    <button v-for="d in ['–°–î–≠–ö', '–ü–û–ß–¢–ê', '5POST']" :key="d" @click="setDelivery(d)" :class="['cat-tab', {active: deliv === d}]">{{d}}</button>
                </div>

                <div id="map" v-show="deliv"></div>
                <div v-if="address" style="font-size:12px; font-weight:700; margin-bottom: 20px;">üìç {{address}}</div>

                <button class="btn-black" style="width:100%; height:60px; font-size: 14px;" @click="checkout">–û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó ‚Ä¢ {{total}} ‚ÇΩ</button>
            </div>
        </div>
    </div>


    <div v-if="tab === 'profile'">
    <div style="text-align:center; margin-bottom: 30px;">
        <img :src="user.photo_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" style="width:80px; height:80px; border-radius:50%; border: 1px solid #000; padding: 3px;">
        <div style="font-weight:800; margin-top:10px; text-transform:uppercase;">{{user.first_name || '–ö–ª–∏–µ–Ω—Ç'}}</div>
        <button @click="openSupport" class="cat-tab" style="margin-top:15px; width:100%;">–ù–ê–ü–ò–°–ê–¢–¨ –í –ü–û–î–î–ï–†–ñ–ö–£</button>
    </div>

    <h2 class="brand-name" style="font-size: 16px; margin-bottom: 20px;">–ú–û–ò –ó–ê–ö–ê–ó–´</h2>
    
    <div v-if="myOrders.length === 0" style="text-align:center; padding:40px; color:var(--gray);">
        –£ –í–ê–° –ü–û–ö–ê –ù–ï–¢ –ó–ê–ö–ê–ó–û–í
    </div>

    <div v-for="o in myOrders" :key="o.id" class="order-card" style="background: #fff; padding: 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #eee; position: relative; z-index: 1;">
        <div style="display: flex; justify-content: space-between; font-weight: 800; font-size: 11px; margin-bottom: 10px;">
        <span>–ó–ê–ö–ê–ó ‚Ññ{{ o.order_id || o.id.slice(0,6) }}</span>
        <span :style="{color: o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' ? '#34c759' : '#007aff'}">{{ o.status || '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ' }}</span>
    </div>

    <div v-for="item in o.items" :key="item.id" style="display: flex; align-items: center; gap: 10px; margin-top: 10px; padding-top: 10px; border-top: 1px solid #f9f9f9; position: relative;">
        <img :src="item.image" style="width: 45px; height: 45px; border-radius: 8px; object-fit: cover;">
        
        <div style="flex: 1;">
            <div style="font-size: 12px; font-weight: 700;">{{ item.title }}</div>
            <div style="font-size: 10px; color: var(--gray);">–†–∞–∑–º–µ—Ä: {{ item.selSize || item.size || '‚Äî' }}</div>
        </div>

        <button v-if="o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' && !o.reviewed" 
            @click.stop="openReviewModal(o, item)" 
            style="
                position: relative; 
                z-index: 99; 
                cursor: pointer;
                background: #000; 
                color: #fff; 
                border: none; 
                padding: 8px 14px; 
                border-radius: 10px; 
                font-size: 10px; 
                font-weight: 800;
                -webkit-appearance: none;
                pointer-events: auto;
            ">
            –û–¢–ó–´–í
        </button>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px; padding-top: 8px; border-top: 1px dashed #eee;">
        <div style="font-size: 9px; color: gray;">{{ o.date }}</div>
        <div style="font-size: 11px; font-weight: 800;">–ò–¢–û–ì–û: {{ o.order_total || o.total }} ‚ÇΩ</div>
    </div>
    </div>
</div> <div v-if="tab === 'admin' && isAdmin">
  <div class="admin-section" style="padding-bottom: 100px;"> 
        <h2 class="brand-name" style="font-size: 14px; margin-bottom: 20px;">–ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨</h2>
     <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 25px;">
             <div style="background: var(--light); color: var(--dark); padding: 16px; border-radius: 15px;">
            <div style="font-size: 9px; font-weight: 800; opacity: 0.6; letter-spacing: 1px; margin-bottom: 5px;">–°–ï–ì–û–î–ù–Ø</div>
            <div style="font-size: 18px; font-weight: 800;">{{ stats.todayRev.toLocaleString() }} ‚ÇΩ</div>
            <div style="font-size: 10px; opacity: 0.8;">{{ stats.todayCount }} –∑–∞–∫.</div>
           </div>

            <div style="background: var(--light); color: var(--dark); padding: 16px; border-radius: 15px;">
             <div style="font-size: 9px; font-weight: 800; color: var(--gray); letter-spacing: 1px; margin-bottom: 5px;">–ú–ï–°–Ø–¶</div>
            <div style="font-size: 18px; font-weight: 800;">{{ stats.monthRev.toLocaleString() }} ‚ÇΩ</div>
            <div style="font-size: 10px; color: var(--gray);">{{ stats.monthCount }} –∑–∞–∫.</div>
            </div>

            <div style="grid-column: span 2; background: #fff; padding: 16px; border-radius: 15px; border: 1px solid var(--light); display: flex; justify-content: space-between; align-items: center;">
             <div>
            <div style="font-size: 9px; font-weight: 800; color: var(--gray); letter-spacing: 1px;">–û–ë–©–ê–Ø –í–´–†–£–ß–ö–ê</div>
            <div style="font-size: 20px; font-weight: 800;">{{ stats.allRev.toLocaleString() }} ‚ÇΩ</div>
             </div>
             <div style="text-align: right;">
            <div style="font-size: 9px; font-weight: 800; color: var(--gray); letter-spacing: 1px;">–í–°–ï–ì–û –ó–ê–ö–ê–ó–û–í</div>
             <div style="font-size: 20px; font-weight: 800;">{{ stats.allCount }}</div>
             </div>
         </div>
    </div>

    <div style="background: #fff; padding: 15px; border-radius: 20px; border: 1px solid #eee; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.03);">
         <div style="font-size: 10px; font-weight: 800; color: var(--gray); letter-spacing: 1px; margin-bottom: 15px;">–î–ò–ù–ê–ú–ò–ö–ê –ó–ê–ö–ê–ó–û–í (7 –î–ù–ï–ô)</div>
         <canvas id="salesChart" style="max-height: 200px;"></canvas>
    </div>
            
            <div class="field">
                <label>–î–û–ë–ê–í–ò–¢–¨ –ö–ê–¢–ï–ì–û–†–ò–Æ</label>
                <div style="display:flex; gap:10px;">
                    <input v-model="newCat" class="input-admin" placeholder="–ù–ê–ó–í–ê–ù–ò–ï">
                    <button class="btn-black" @click="manageCategory('add')" style="padding: 10px;">+</button>
                </div>
                <div style="display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;">
                    <span v-for="c in categories" :key="c.id" class="sale-badge" @click="manageCategory('del', c.id)">{{c.name}} ‚úï</span>
                </div>
            </div>

            <hr style="border: 0; border-top: 1px solid #eee; margin: 20px 0;">

            <div class="field">
                <label>–¢–û–í–ê–†: –ù–ê–ó–í–ê–ù–ò–ï</label>
                <input v-model="newP.title" class="input-admin">
            </div>
            <div class="field">
                <label>–û–ü–ò–°–ê–ù–ò–ï</label>
                <textarea v-model="newP.desc" class="input-admin" style="height:80px;"></textarea>
            </div>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div class="field">
                    <label>–¶–ï–ù–ê (‚ÇΩ)</label>
                    <input v-model="newP.price" type="number" class="input-admin">
                </div>
                <div class="field">
                    <label>–°–¢–ê–†–ê–Ø –¶–ï–ù–ê (SALE)</label>
                    <input v-model="newP.oldPrice" type="number" class="input-admin">
                </div>
            </div>
            <div class="field">
                <label>–ö–ê–¢–ï–ì–û–†–ò–Ø</label>
                <select v-model="newP.category" class="input-admin">
                    <option v-for="c in categories" :value="c.name">{{c.name}}</option>
                </select>
            </div>
            <div class="field">
                <label>–†–ê–ó–ú–ï–†–´ (–ß–ï–†–ï–ó –ó–ê–ü–Ø–¢–£–Æ)</label>
                <input v-model="newP.sizes" class="input-admin" placeholder="42, 44, 46">
            </div>
            <div class="field">
                <label>–¶–í–ï–¢</label>
                <input v-model="newP.color" class="input-admin">
            </div>
            <div class="field">
                <label>–§–û–¢–û (–ú–û–ñ–ù–û –ù–ï–°–ö–û–õ–¨–ö–û)</label>
                <input type="file" multiple @change="uploadImages" class="input-admin" style="padding: 8px;">
            </div>

            <button class="btn-black" style="width:100%; margin-top:10px;" @click="saveProduct" :disabled="loading">
                {{ loading ? '–ó–ê–ì–†–£–ó–ö–ê...' : (editId ? '–°–û–•–†–ê–ù–ò–¢–¨ –ò–ó–ú–ï–ù–ï–ù–ò–Ø' : '–û–ü–£–ë–õ–ò–ö–û–í–ê–¢–¨ –¢–û–í–ê–†') }}
            </button>
            <button v-if="editId" class="cat-tab" style="width:100%; margin-top:5px;" @click="cancelEdit">–û–¢–ú–ï–ù–ê</button>

            <div style="margin-top: 20px; border: 1px solid #eee; border-radius: 12px; overflow: hidden; background: #f9f9f9;">
               <div @click="showProductList = !showProductList" 
                  style="padding: 15px; background: #000; color: #fff; display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                  <span style="font-weight: 800; font-size: 11px; letter-spacing: 1px;">üì¶ –°–ü–ò–°–û–ö –¢–û–í–ê–†–û–í ({{ products.length }})</span>
                  <span style="font-size: 18px;">{{ showProductList ? '‚àí' : '+' }}</span>
             </div>

             <div v-if="showProductList" style="padding: 5px; max-height: 400px; overflow-y: auto; background: #fff;">



                <div v-for="p in products" :key="p.id" 
     style="display: flex; align-items: center; gap: 10px; padding: 10px; border-bottom: 1px solid #f2f2f7;"
     :style="{ opacity: p?.hidden ? '0.4' : '1' }">
    <img :src="p.images ? p.images[0] : ''" style="width: 40px; height: 50px; object-fit: cover; border-radius: 4px; background: #eee;">
    <div style="flex: 1; min-width: 0;">
        <div style="font-weight: 700; font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">{{ p.title }}</div>
        <div style="font-size: 11px; color: #8e8e93;">{{ p.price }} ‚ÇΩ</div>
    </div>
    <div style="display: flex; gap: 12px;">
        <button @click="editProduct(p)" style="border:none; background:none; font-size: 16px; cursor: pointer;">‚úèÔ∏è</button>
        <button @click="toggleVisibility(p)" style="border:none; background:none; cursor: pointer; font-size: 16px;">
            {{ p?.hidden ? 'üëÅÔ∏è‚Äçüó®Ô∏è' : 'üëÅÔ∏è' }}
        </button>
        <button @click="deleteProduct(p.id)" style="border:none; background:none; font-size: 16px; cursor: pointer;">üóë</button>
    </div>
</div>
             </div>

           <hr style="margin: 6px 0; border: none; border-top: 2px solid #000;">  

            <h3 class="brand-name" style="font-size:12px; margin-top:2px;">–ó–ê–ö–ê–ó–´ ({{allOrders.length}}) | –í–´–†–£–ß–ö–ê: {{revenue}} ‚ÇΩ</h3>
            <div v-for="o in allOrders" :key="o.id" 
                class="order-card" 
                 style="background: #ffffff; 
                  border-radius: 20px; 
                  padding: 16px; 
                  margin-bottom: 20px; 
                  box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
                  border: 1px solid rgba(0,0,0,0.03);">

               
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
        <div>
            <div style="font-weight: 800; font-size: 16px; display: block;">#{{ o.order_id }}</div>
        </div>

        <div @click="deleteOrder(o.id); vib()"
             style="color: #ff3b30; font-size: 10px; font-weight: 800; cursor: pointer; border: 1.5px solid #ff3b30; padding: 4px 8px; border-radius: 8px; text-transform: uppercase;">
            –£–î–ê–õ–ò–¢–¨ üóë
        </div>
    </div>

    <div style="font-size: 13px; color: #000; margin-bottom: 12px; line-height: 1.4;">
        <div style="margin-bottom: 2px;">üë§ <b>{{ o.customer_name }}</b></div>
        <div style="margin-bottom: 2px;">üìû <span style="color: #007aff;">{{ o.customer_phone }}</span></div>
        <div style="color: #8e8e93; font-size: 12px;">üìç {{ o.address }} ({{ o.delivery || o.delivery_type }})</div>
    </div>

    <div style="background: #f2f2f7; padding: 10px; border-radius: 12px; margin-bottom: 15px;">
        <div v-if="o.items && o.items.length > 0">
            <div v-for="item in o.items" :key="item.id" style="font-size: 12px; margin-bottom: 6px; border-bottom: 1px solid #e5e5ea; padding-bottom: 4px; color: #000;">
                <div style="font-weight: 700;">{{ item.title }} ‚Äî {{ item.count || 1 }} —à—Ç.</div>
                <div style="font-size: 11px; color: #8e8e93;">
                    üé® –¶–≤–µ—Ç: {{ item.color || '-' }} | üìè –†–∞–∑–º: {{ item.size || item.selSize || '-' }}
                </div>
            </div>
        </div>
        <div v-else style="font-size: 12px; white-space: pre-wrap;">{{ o.items_text }}</div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <span style="font-size: 11px; font-weight: 700; color: #8e8e93;">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï</span>
        <span style="font-size: 18px; font-weight: 800;">{{ o.order_total }} ‚ÇΩ</span>
    </div>

    <div style="display: flex; gap: 8px;">
        <button @click="updateStatus(o, '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω')" 
                :disabled="o.status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' || o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' || o.isUpdating"
                :style="{
                    flex: '1', height: '46px', borderRadius: '12px', border: 'none', fontSize: '10px', fontWeight: '800',
                    background: (o.status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' || o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω') ? '#34c759' : '#ff3b30',
                    color: '#fff'
                }">
            {{ (o.status === '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω' || o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω') ? '–û–¢–ü–†–ê–í–õ–ï–ù–û ‚úÖ' : '–û–¢–ü–†–ê–í–ò–¢–¨' }}
        </button>

        <button @click="updateStatus(o, '–î–æ—Å—Ç–∞–≤–ª–µ–Ω')" 
                :disabled="o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' || o.isUpdating"
                :style="{
                    flex: '1', height: '46px', borderRadius: '12px', border: 'none', fontSize: '10px', fontWeight: '800',
                    background: o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' ? '#34c759' : '#ff3b30',
                    color: '#fff'
                }">
            {{ o.status === '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' ? '–î–û–°–¢–ê–í–õ–ï–ù–û ‚úÖ' : '–î–û–°–¢–ê–í–ò–¢–¨' }}
        </button>

        <button @click="printOrder(o)" 
                style="width: 46px; height: 46px; border-radius: 12px; border: 1px solid #eee; background: #fff; font-size: 20px; display: flex; align-items: center; justify-content: center;">
            üìÑ
        </button>
    </div>
    </div>      
    </div>
    </div>
</main>

    <div v-if="selP" class="modal" style="z-index: 5000;">
        <button class="close-modal" @click="selP = null">‚úï</button>
        <div class="slider-wrapper" style="aspect-ratio: 1/1.2;">
            <div class="slider-inner" @scroll="e => handleScroll(e, selP)">
                <img v-for="img in selP.images" :key="img" :src="img">
            </div>
            <div class="dots">
                <span v-for="(img, i) in selP.images" :key="i" :class="['dot', {active: i === (selP.aIdx || 0)}]"></span>
            </div>
        </div>
        <div style="padding: 25px;">
            <div style="display:flex; justify-content:space-between; align-items: flex-start;">
                <h2 class="brand-name" style="font-size: 18px; margin:0;">{{selP.title}}</h2>
                <div class="price" style="font-size: 20px;">{{selP.price}} ‚ÇΩ</div>
            </div>
            
            <p style="font-size: 13px; line-height: 1.6; margin: 20px 0; color: #444;">{{selP.desc}}</p>

            <div v-if="productReviews.length > 0" style="margin-top:20px; border-top:1px solid #f2f2f7; padding-top:15px;">
              <div style="font-size:10px; font-weight:800; letter-spacing:1px; margin-bottom:15px;">–û–¢–ó–´–í–´ –ü–û–ö–£–ü–ê–¢–ï–õ–ï–ô</div>
               <div v-for="rev in productReviews" :key="rev.id" style="margin-bottom:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                <span style="font-weight:700; font-size:11px;">{{rev.userName}}</span>
                 <span style="font-size:10px;">‚≠ê {{rev.rating}}</span>
              </div>
              <p style="font-size:11px; margin-top:5px; color:#333; line-height:1.4;">{{rev.text}}</p>
             </div>
            </div>
            
            <div style="font-size: 10px; font-weight: 800; text-transform: uppercase;">–í–´–ë–ï–†–ò–¢–ï –†–ê–ó–ú–ï–†</div>
            <div class="size-grid">
                <button v-for="s in selP.sizes.split(',')" :key="s" @click="selP.selSize = s.trim(); vib()" :class="['size-btn', {active: selP.selSize === s.trim()}]">
                    {{s.trim()}}
                </button>
            </div>

            <div style="font-size: 10px; font-weight: 800; text-transform: uppercase;">–¶–í–ï–¢: {{selP.color}}</div>

            <div class="btn-row" style="margin-top: 30px; gap: 10px;">
                <button class="btn-fav" @click="toggleFav(selP)" style="width: 60px; height: 60px;">
                    <svg :fill="isFav(selP) ? '#000' : 'none'" viewBox="0 0 24 24" width="24" height="24" stroke="currentColor" stroke-width="2"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                </button>
                <button class="btn-black" @click="addToCart(selP)" style="height: 60px; font-size: 14px;">–î–û–ë–ê–í–ò–¢–¨ –í –ö–û–†–ó–ò–ù–£</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button v-for="btn in nav" :key="btn.id" @click="tab = btn.id; vib()" :class="['nav-item', {active: tab === btn.id}]">
            <div v-if="btn.id === 'cart' && cartCount > 0" class="badge">{{cartCount}}</div>
            <svg v-html="btn.icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"></svg>
            <span>{{btn.label}}</span>
        </button>

        <div v-if="showReviewModal" 
     style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 99999; display: flex; align-items: center; justify-content: center; backdrop-filter: blur(4px);" 
     @click.self="showReviewModal = false">
    
    <div style="background: #fff; padding: 24px; border-radius: 24px; width: 90%; max-width: 400px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
        <h3 style="margin-top: 0; font-size: 16px; font-weight: 800; text-transform: uppercase;">–û—Ç–∑—ã–≤ –æ —Ç–æ–≤–∞—Ä–µ</h3>
        <p style="font-size: 12px; color: #8e8e93; margin-bottom: 20px;">{{ selectedProductForReview?.title }}</p>
        
        <div style="display: flex; gap: 10px; margin-bottom: 25px; font-size: 35px; justify-content: center; user-select: none;">
            <span v-for="i in 5" :key="i" 
                  @click="rating = i" 
                  :style="{ color: i <= rating ? '#ffb400' : '#e5e5ea', cursor: 'pointer' }">
                {{ i <= rating ? '‚òÖ' : '‚òÜ' }}
            </span>
        </div>

        <textarea v-model="reviewText" 
                  placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –∫–∞—á–µ—Å—Ç–≤–µ —Ç–æ–≤–∞—Ä–∞..." 
                  style="width: 100%; height: 100px; border: 1px solid #eee; border-radius: 12px; padding: 12px; font-family: inherit; font-size: 14px; margin-bottom: 20px; resize: none;"></textarea>

        <button @click="submitFinalReview" 
                :disabled="loading || rating === 0"
                style="width: 100%; height: 50px; background: #000; color: #fff; border: none; border-radius: 14px; font-weight: 700; cursor: pointer;">
            {{ loading ? '–û–¢–ü–†–ê–í–ö–ê...' : '–û–¢–ü–†–ê–í–ò–¢–¨ –û–¢–ó–´–í' }}
        </button>
        
        <button @click="showReviewModal = false" 
                style="width: 100%; background: none; border: none; margin-top: 15px; color: #8e8e93; font-size: 12px;">
            –û–¢–ú–ï–ù–ê
        </button>
    </div>
</div>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw",
        authDomain: "naran-80077.firebaseapp.com",
        projectId: "naran-80077",
        storageBucket: "naran-80077.firebasestorage.app",
        messagingSenderId: "901156477154",
        appId: "IG-PR8PLCMF3C"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    window.db = db;
    window.fb = { collection, addDoc, onSnapshot, query, orderBy, doc, deleteDoc, updateDoc, where, serverTimestamp };
</script>

<script>
const tg = window.Telegram.WebApp;

Vue.createApp({
    data() {
        return {
            tab: 'catalog',
            currentCat: '',
            searchQuery: '',
            searchMode: false,
            burgerOpen: false,
            loading: false,
            activeInfo: null,
            
            products: [], // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—É—Å—Ç—ã–º –º–∞—Å—Å–∏–≤–æ–º –¥–ª—è –∑–∞—â–∏—Ç—ã
            categories: [],
            allReviews: [],
            cart: JSON.parse(localStorage.getItem('naran_cart_v3') || '[]'),
            favorites: JSON.parse(localStorage.getItem('naran_favs_v3') || '[]'),
            
            showReviewModal: false,   // –û—Ç–∫—Ä—ã—Ç–æ –ª–∏ –æ–∫–Ω–æ
            selectedOrderForReview: null,     // –•—Ä–∞–Ω–∏–º –æ–±—ä–µ–∫—Ç –∑–∞–∫–∞–∑–∞
            selectedProductForReview: null,   // –•—Ä–∞–Ω–∏–º –æ–±—ä–µ–∫—Ç —Ç–æ–≤–∞—Ä–∞
            rating: 0,            // –û—Ü–µ–Ω–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            reviewText: '',           // –¢–µ–∫—Å—Ç –æ—Ç–∑—ã–≤–∞
            reviewImages: [],                 // –ú–∞—Å—Å–∏–≤ –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Ñ–æ—Ç–æ

            user: {},
            isAdmin: false,
            adminId: 387881523,
            
            selP: null,
            deliv: '',
            address: '',
            map: null,
            form: {
                name: '',
                phone: localStorage.getItem('naran_phone') || ''
            },
            
            // Admin Fields
            newP: { title: '', desc: '', price: '', oldPrice: '', category: '', sizes: '42, 44, 46', color: '', images: [] },
            newCat: '',
            editId: null,
            showProductList: false,
            allOrders: [],
            chart: null,
            myOrders: [],

            nav: [
                { id: 'catalog', label: '–ö–∞—Ç–∞–ª–æ–≥', icon: '<rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect>' },
                { id: 'favs', label: '–ò–∑–±—Ä–∞–Ω–Ω–æ–µ', icon: '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>' },
                { id: 'cart', label: '–ö–æ—Ä–∑–∏–Ω–∞', icon: '<circle cx="9" cy="21" r="1"></circle><circle cx="20" cy="21" r="1"></circle><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>' },
                { id: 'profile', label: '–ü—Ä–æ—Ñ–∏–ª—å', icon: '<path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle>' }
            ]
        }
    },
    computed: {
        stats() {
        const now = new Date();
        const startOfDay = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
        const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

        let todayCount = 0, todayRev = 0;
        let monthCount = 0, monthRev = 0;
        let allCount = 0, allRev = 0;

        this.allOrders.forEach(o => {
            // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –¥–∞—Ç—É –∏–∑ Firebase (Timestamp) –≤ JavaScript Date
            const orderDate = o.createdAt?.seconds ? o.createdAt.seconds * 1000 : 0;
            const total = parseFloat(o.order_total) || 0;

            allCount++;
            allRev += total;

            if (orderDate >= startOfMonth) {
                monthCount++;
                monthRev += total;
            }

            if (orderDate >= startOfDay) {
                todayCount++;
                todayRev += total;
            }
        });

        return { todayCount, todayRev, monthCount, monthRev, allCount, allRev };
    },
       filteredProducts() {
    // 1. –ë—ã—Å—Ç—Ä–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
    if (!this.products || !Array.isArray(this.products)) return [];
    
    try {
        // 2. –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –æ–¥–∏–Ω —Ä–∞–∑ (–æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è)
        const query = (this.searchQuery || '').toLowerCase().trim();
        const targetCat = (this.currentCat || '').toLowerCase().trim();

        return this.products.filter(p => {
            // 3. –ó–∞—â–∏—Ç–∞: –ø—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ–±—ä–µ–∫—Ç —Ç–æ–≤–∞—Ä–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
            if (!p) return false;

            // 4. –°–ö–†–´–¢–ò–ï: –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ hidden, –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–≥–æ –∫–ª–∏–µ–Ω—Ç—É
            // (p?.hidden –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –≤–µ—Ä–Ω–µ—Ç false, –µ—Å–ª–∏ —Å–≤–æ–π—Å—Ç–≤–∞ –µ—â–µ –Ω–µ—Ç –≤ –±–∞–∑–µ)
            if (p?.hidden === true) return false;

            // 5. –ü–û–ò–°–ö
            const titleMatch = query === '' || 
                (p.title && String(p.title).toLowerCase().includes(query));

            // 6. –ö–ê–¢–ï–ì–û–†–ò–Ø
            let catMatch = true;
            if (targetCat !== '' && targetCat !== '–≤—Å–µ') {
                const prodCat = p.category ? String(p.category).toLowerCase().trim() : '';
                catMatch = (prodCat === targetCat);
            }

            return titleMatch && catMatch;
        });
    } catch (e) {
        console.error("–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏:", e);
        return [];
    }
},
productReviews() {
        if (!this.selP) return [];
        return this.allReviews.filter(rev => rev.productId === this.selP.id);
    },
        favList() {
            if (!this.products) return [];
            return this.products.filter(p => this.favorites.includes(p.id));
        },
        
        // 1. –°—á–∏—Ç–∞–µ—Ç —Å—É–º–º—É –¢–û–í–ê–†–û–í –í –ö–û–†–ó–ò–ù–ï (–¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è)
        total() {
            return this.cart.reduce((sum, item) => {
                return sum + (Number(item.price) * Number(item.qty));
            }, 0);
        },

        // 2. –°—á–∏—Ç–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –®–¢–£–ö –≤ –∫–æ—Ä–∑–∏–Ω–µ (–¥–ª—è –∫—Ä–∞—Å–Ω–æ–≥–æ –∫—Ä—É–∂–∫–∞ –Ω–∞ –∏–∫–æ–Ω–∫–µ)
        cartCount() {
            return this.cart.reduce((sum, item) => sum + Number(item.qty), 0);
        },

        // 3. –°—á–∏—Ç–∞–µ—Ç –í–´–†–£–ß–ö–£ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏)
        revenue() {
            return this.allOrders
                .filter(o => o.status !== '–û—Ç–º–µ–Ω–µ–Ω')
                .reduce((sum, order) => sum + (Number(order.order_total) || 0), 0);
        },
    },
    methods: {
        vib() { tg.HapticFeedback.impactOccurred('light'); },
        
        setCategory(name) {
            try {
                this.vib();
                // "–í—Å–µ —Ç–æ–≤–∞—Ä—ã" —Å–±—Ä–∞—Å—ã–≤–∞—é—Ç –≤ –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É —Å—Ç—Ä–æ–≥–æ
                this.currentCat = name || '';
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (err) {
                console.error("–û—à–∏–±–∫–∞ —Å–º–µ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:", err);
                this.currentCat = '';
            }
        },

        handleScroll(e, p) {
            if (!p) return;
            const idx = Math.round(e.target.scrollLeft / e.target.offsetWidth);
            p.aIdx = idx;
        },

        openProduct(p) {
            this.vib();
            this.selP = { ...p, aIdx: 0, selSize: p.sizes.split(',')[0].trim(), selColor: p.color };
        },

        isFav(p) { return p && this.favorites.includes(p.id); },
        
        toggleFav(p) {
            this.vib();
            const idx = this.favorites.indexOf(p.id);
            if (idx > -1) {
                this.favorites.splice(idx, 1);
            } else {
                this.favorites.push(p.id);
            }
            localStorage.setItem('naran_favs_v3', JSON.stringify(this.favorites));
        },

        addToCart(p) {
    this.vib();
    const cartId = p.id + p.selSize + p.selColor;
    const exist = this.cart.find(i => i.cartId === cartId);
    
    if (exist) {
        exist.qty++;
    } else {
        // –î–æ–±–∞–≤–ª—è–µ–º Number(p.price), —á—Ç–æ–±—ã —Ü–µ–Ω–∞ –≤—Å–µ–≥–¥–∞ –±—ã–ª–∞ —á–∏—Å–ª–æ–º
        this.cart.push({ ...p, cartId, qty: 1, price: Number(p.price) });
    }
    
    this.saveCart();
    this.selP = null;
    tg.HapticFeedback.notificationOccurred('success');
},

        quickAddToCart(p) {
    this.vib();
    const selectedSize = p.tempSize || p.sizes.split(',')[0].trim();
    const cartId = p.id + selectedSize + p.color;
    const exist = this.cart.find(i => i.cartId === cartId);
    if (exist) {
        exist.qty++;
    } else {
        this.cart.push({ ...p, cartId, selSize: selectedSize, selColor: p.color, qty: 1 });
    }
    this.saveCart();
    tg.HapticFeedback.notificationOccurred('success');
},

        changeQty(item, delta) {
            item.qty += delta;
            if (item.qty <= 0) this.removeFromCart(item.cartId);
            this.saveCart();
        },

        removeFromCart(cartId) {
            this.cart = this.cart.filter(i => i.cartId !== cartId);
            this.saveCart();
        },

        saveCart() {
            localStorage.setItem('naran_cart_v3', JSON.stringify(this.cart));
        },

        setDelivery(d) {
    this.deliv = d; // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –≤ deliv, —Ç–∞–∫ –∫–∞–∫ –æ–Ω–∞ —É —Ç–µ–±—è –≤ data()
    this.vib();
    // –ï—Å–ª–∏ —É —Ç–µ–±—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –∫–∞—Ä—Ç–∞ –ø—Ä–∏ –≤—ã–±–æ—Ä–µ:
    if (this.initMap) this.initMap();
        },
        

        initMap() {
            try {
                if (this.map) { this.map.destroy(); this.map = null; }
                
                // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É –∫–ª—é—á–∞: –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–ª—é—á –Ω–∞–ø—Ä—è–º—É—é
                const currentKey = 'cab82c94-e619-42eb-9814-3361712feaf0';
                
                this.map = new mapgl.Map('map', {
                    center: [37.6175, 55.7558],
                    zoom: 13,
                    key: currentKey
                });

                const setPos = (lat, lon) => {
                    this.map.setCenter([lon, lat]);
                    this.map.setZoom(15);
                    this.getAddress(lat, lon);
                };

                // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Telegram –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º
                // –ï—Å–ª–∏ –º—ã –≤ –±—Ä–∞—É–∑–µ—Ä–µ –Ω–∞ –ü–ö, –∫–æ–¥ –ø—Ä–æ—Å—Ç–æ –ø–æ–π–¥–µ—Ç –¥–∞–ª—å—à–µ –±–µ–∑ –æ—à–∏–±–∫–∏
                if (window.Telegram?.WebApp?.initData !== "") {
                    try {
                        window.Telegram.WebApp.requestLocation((data) => {
                            if (data?.location) setPos(data.location.latitude, data.location.longitude);
                        });
                    } catch (e) { console.log("TG Geo skip"); }
                } 
                
                // –í—Å–µ–≥–¥–∞ –ø—Ä–æ–±—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –±—Ä–∞—É–∑–µ—Ä–Ω—ã–π –º–µ—Ç–æ–¥ (–æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –ü–ö)
                navigator.geolocation.getCurrentPosition(
                    (p) => setPos(p.coords.latitude, p.coords.longitude),
                    (err) => console.log("–ì–µ–æ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º")
                );

                this.map.on('click', (e) => {
                    this.getAddress(e.lngLat[1], e.lngLat[0]);
                });
            } catch (e) { console.error("Map error", e); }
        },

        getAddress(lat, lon) {
            const currentKey = 'cab82c94-e619-42eb-9814-3361712feaf0';
            const url = `https://catalog.api.2gis.com/3.0/items/geocode?lat=${lat}&lon=${lon}&radius=50&key=${currentKey}`;

            fetch(url)
                .then(r => r.json())
                .then(res => {
                    if (res.result?.items?.length) {
                        const addrName = res.result.items[0].address_name || res.result.items[0].name;
                        
                        // –í –≤–∞—à–µ–º —Ñ–∞–π–ª–µ –∞–¥—Ä–µ—Å –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞—Å—Ç—å –≤ –¢–†–ò –º–µ—Å—Ç–∞, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å:
                        const fullAddr = (this.deliv ? this.deliv + ': ' : '') + addrName;
                        
                        this.address = fullAddr; // 1. –î–ª—è —Ç–µ–∫—Å—Ç–∞ –ø–æ–¥ –∫–∞—Ä—Ç–æ–π üìç
                        if (this.form) this.form.address = fullAddr; // 2. –î–ª—è –¥–∞–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–∞
                        localStorage.setItem('naran_last_addr', fullAddr); // 3. –í –ø–∞–º—è—Ç—å
                        
                        // –í–∞–∂–Ω–æ –¥–ª—è Vue: –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–∏—Ç—å —ç–∫—Ä–∞–Ω
                        this.$forceUpdate();
                        
                        if (window.Telegram?.WebApp?.HapticFeedback) {
                            window.Telegram.WebApp.HapticFeedback.impactOccurred('light');
                        }
                    }
                })
                .catch(err => console.error("2GIS error", err));
        },

        openSupport() { window.open('https://t.me/opttania', '_blank'); },

        async uploadImages(e) {
            this.loading = true;
            const files = e.target.files;
            for (let f of files) {
                const fd = new FormData();
                fd.append('image', f);
                try {
                    const r = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body: fd });
                    const d = await r.json();
                    if (d.data?.url) this.newP.images.push(d.data.url);
                } catch (err) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.');
                }
            }
            this.loading = false;
        },

        async saveProduct() {
            if (!this.newP.title || !this.newP.price || this.newP.images.length === 0) {
                return alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ');
            }
            this.loading = true;
            try {
                const data = {
                    ...this.newP,
                    price: Number(this.newP.price),
                    oldPrice: this.newP.oldPrice ? Number(this.newP.oldPrice) : null,
                    updatedAt: Date.now()
                };

                if (this.editId) {
                    await window.fb.updateDoc(window.fb.doc(window.db, "products", this.editId), data);
                    this.editId = null;
                } else {
                    data.createdAt = Date.now();
                    data.hidden = false;
                    await window.fb.addDoc(window.fb.collection(window.db, "products"), data);
                }
                this.newP = { title: '', desc: '', price: '', oldPrice: '', category: '', sizes: '42, 44, 46', color: '', images: [] };
                alert('–ì–æ—Ç–æ–≤–æ!');
            } catch (e) { alert(e.message); }
            this.loading = false;
        },

        editProduct(p) {
            this.editId = p.id;
            this.newP = { ...p };
            window.scrollTo({ top: 0, behavior: 'smooth' });
        },

        cancelEdit() {
            this.editId = null;
            this.newP = { title: '', desc: '', price: '', oldPrice: '', category: '', sizes: '42, 44, 46', color: '', images: [] };
        },

        async deleteProduct(id) {
            const msg = "‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞–≤—Å–µ–≥–¥–∞?";
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞: –∫–∞–∫ —Å–ø—Ä–∞—à–∏–≤–∞—Ç—å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
    const runDelete = async () => {
        try {
            await window.fb.deleteDoc(window.fb.doc(window.db, "orders", docId));
            if (window.tg && window.tg.HapticFeedback) window.tg.HapticFeedback.notificationOccurred('success');
        } catch (e) {
            console.error(e);
            alert("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + e.message);
        }
    };

    if (window.tg && window.tg.showConfirm) {
        // –ï—Å–ª–∏ –≤ —Ç–µ–ª–µ–≥—Ä–∞–º–µ
        window.tg.showConfirm(msg, (yes) => { if (yes) runDelete(); });
    } else {
        // –ï—Å–ª–∏ –Ω–∞ –∫–æ–º–ø—å—é—Ç–µ—Ä–µ
        if (confirm(msg)) runDelete();
    }
},

        async toggleVisibility(p) {
    if (!p || !p.id) return;
    
    // 1. –°–Ω–∞—á–∞–ª–∞ –º–µ–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
    p.hidden = !p.hidden;
    this.vib(); // –í–∏–±—Ä–∞—Ü–∏—è –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –¥–µ–π—Å—Ç–≤–∏—è

    try {
        // 2. –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
        const productRef = window.fb.doc(window.db, "products", p.id);
        await window.fb.updateDoc(productRef, { 
            hidden: p.hidden 
        });
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:", e);
        // –ï—Å–ª–∏ –±–∞–∑–∞ –≤—ã–¥–∞–ª–∞ –æ—à–∏–±–∫—É ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–∞–∫ –±—ã–ª–æ
        p.hidden = !p.hidden;
        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö");
    }
},
async manageCategory(action, id) { // –î–æ–±–∞–≤—å async –∑–¥–µ—Å—å
    if (action === 'add' && this.newCat) {
        await window.fb.addDoc(window.fb.collection(window.db, "categories"), { name: this.newCat.trim() });
        this.newCat = '';
    } else if (action === 'del') {
        await window.fb.deleteDoc(window.fb.doc(window.db, "categories", id));
    }
},

       async checkout() {
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (this.cart.length === 0) return alert('–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');
    if (!this.form.name) return alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è');
    if (!this.form.phone) return alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω');

    if (!this.deliv || this.deliv === '' || this.deliv === '–ù–µ –≤—ã–±—Ä–∞–Ω') {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –¥–æ—Å—Ç–∞–≤–∫–∏');
        return; 
    }

    if (!this.address || this.address.trim() === '' || this.address.includes('–ê–¥—Ä–µ—Å –Ω–µ –≤—ã–±—Ä–∞–Ω')) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏');
        return;
    }

    this.loading = true;

    try {
        const orderId = Date.now().toString().slice(-6);
        
        // –¢–µ–∫—Å—Ç –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ –±–æ—Ç (–æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ —É –≤–∞—Å –±—ã–ª–æ)
        const itemsText = this.cart.map(item => 
            `‚ñ´Ô∏è ${item.title} ${item.selSize ? '('+item.selSize+')' : ''} x${item.qty} ‚Äî ${item.price * item.qty} ‚ÇΩ`
        ).join('\n');

        const orderData = {
            order_id: orderId,
            customer_name: this.form.name,
            customer_phone: this.form.phone,
            order_total: this.total,
            delivery: this.deliv, 
            address: this.address,
            items_text: itemsText, // –î–ª—è –±–æ—Ç–∞
            
            // –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∏ –æ—Ç–∑—ã–≤–æ–≤
            items: this.cart.map(item => ({
                id: item.id,            // ID —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –æ—Ç–∑—ã–≤–∞
                title: item.title,
                price: item.price,
                image: item.images ? item.images[0] : '', // –§–æ—Ç–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞–∫–∞–∑–æ–≤
                size: item.selSize || item.tempSize || '‚Äî'
            })),

            status: '–ù–æ–≤—ã–π',
            reviewed: false, // –ü–æ–º–µ—Ç–∫–∞, —á—Ç–æ –æ—Ç–∑—ã–≤ –µ—â–µ –Ω–µ –æ—Å—Ç–∞–≤–ª–µ–Ω
            user: {
                id: this.user.id || 0,
                username: this.user.username || 'n/a'
            },
            createdAt: window.fb.serverTimestamp()
        };

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Firebase
        await window.fb.addDoc(window.fb.collection(window.db, "orders"), orderData);

        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ Telegram –±–æ—Ç—É
        tg.sendData(JSON.stringify(orderData));
        
        tg.showAlert(`–ó–∞–∫–∞–∑ ‚Ññ${orderId} —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!`);
        
        // –û—á–∏—Å—Ç–∫–∞
        this.cart = [];
        this.saveCart();
        this.deliv = '';
        this.showCart = false;
        this.tab = 'profile';

    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏:", e);
        alert("–û—à–∏–±–∫–∞ Firebase: " + e.message);
    } finally {
        this.loading = false;
    }
},

// –ú–µ—Ç–æ–¥ –¥–ª—è –∫–Ω–æ–ø–æ–∫ "–í –ø—É—Ç–∏" –∏ "–ì–æ—Ç–æ–≤"
async updateStatus(order, newStatus) {
    try {
        order.isUpdating = true;
        const orderRef = window.fb.doc(window.db, "orders", order.id);
        await window.fb.updateDoc(orderRef, { status: newStatus });
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –≤–∏–±—Ä–∞—Ü–∏—è (–ø—Ä–æ–≤–µ—Ä—è–µ–º –≤–µ—Ä—Å–∏—é API)
        if (window.tg && window.tg.version && parseFloat(window.tg.version) >= 6.1) {
            if (window.tg.HapticFeedback) window.tg.HapticFeedback.impactOccurred('medium');
        }
    } catch (e) {
        console.error("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:", e);
        alert("–û—à–∏–±–∫–∞ —Å–≤—è–∑–∏ —Å –±–∞–∑–æ–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
    } finally {
        order.isUpdating = false;
    }
},

async deleteOrder(docId) {
    const confirmText = "‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å –∑–∞–∫–∞–∑ –Ω–∞–≤—Å–µ–≥–¥–∞?";
    
    const proceedDelete = async () => {
        try {
            await window.fb.deleteDoc(window.fb.doc(window.db, "orders", docId));
            if (window.tg && window.tg.version && parseFloat(window.tg.version) >= 6.1) {
                window.tg.HapticFeedback.notificationOccurred('success');
            }
        } catch (e) {
            alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å: " + e.message);
        }
    };

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è (–ü–ö + –¢–ì)
    if (window.tg && window.tg.showConfirm && parseFloat(window.tg.version) >= 6.2) {
        window.tg.showConfirm(confirmText, (yes) => { if (yes) proceedDelete(); });
    } else {
        if (confirm(confirmText)) proceedDelete();
    }
},

       printOrder(o) {
    try {
        const date = o.createdAt ? (o.createdAt.seconds ? new Date(o.createdAt.seconds * 1000).toLocaleString('ru-RU') : new Date(o.createdAt).toLocaleString('ru-RU')) : '---';
        
        // 1. –°–æ–±–∏—Ä–∞–µ–º —Ç–æ–≤–∞—Ä—ã (–∏—â–µ–º –≤–æ –≤—Å–µ—Ö –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ø–æ–ª—è—Ö –±–∞–∑—ã)
        const itemsList = o.items || o.cartItems || [];
        let itemsHtml = "";

        if (Array.isArray(itemsList) && itemsList.length > 0) {
            itemsHtml = itemsList.map(i => `
                <tr style="border-bottom: 2px solid #f0f0f0;">
                    <td style="padding: 20px 0;">
                        <div style="font-weight: 800; font-size: 20px; text-transform: uppercase; margin-bottom: 10px;">
                            ${i.title || '–¢–æ–≤–∞—Ä –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}
                        </div>
                        
                        <div style="display: flex; gap: 30px; font-size: 14px; color: #333;">
                            <span><b>–¶–≤–µ—Ç:</b> ${i.color || '-'}</span>
                            <span><b>–†–∞–∑–º–µ—Ä:</b> ${i.size || i.selSize || '-'}</span>
                            <span><b>–ö–æ–ª-–≤–æ:</b> ${i.count || 1} —à—Ç.</span>
                            <span><b>–¶–µ–Ω–∞ –∑–∞ –µ–¥.:</b> ${i.price || 0} ‚ÇΩ</span>
                        </div>
                    </td>
                    <td style="padding: 20px 0; text-align: right; vertical-align: middle;">
                        <div style="font-weight: 800; font-size: 20px;">
                            ${(i.price || 0) * (i.count || 1)} ‚ÇΩ
                        </div>
                    </td>
                </tr>
            `).join('');
        } else {
            // –ï—Å–ª–∏ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç –≤ –º–∞—Å—Å–∏–≤–µ, –≤—ã–≤–æ–¥–∏–º items_text
            itemsHtml = `<tr><td colspan="2" style="padding: 40px 0; font-size: 16px; white-space: pre-wrap;">${o.items_text || '–°–ø–∏—Å–æ–∫ —Ç–æ–≤–∞—Ä–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω'}</td></tr>`;
        }

        const win = window.open('', '_blank');
        if (!win) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.");
            return;
        }

        win.document.write(`
            <html>
            <head>
                <title>–ù–∞–∫–ª–∞–¥–Ω–∞—è #${o.order_id}</title>
                <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet">
                <style>
                    @page { size: A4 portrait; margin: 15mm; }
                    body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; color: #000; }
                    .wrapper { width: 100%; max-width: 210mm; margin: auto; }
                    .header { display: flex; justify-content: space-between; align-items: flex-start; border-bottom: 4px solid #000; padding-bottom: 20px; margin-bottom: 30px; }
                    .brand h1 { margin: 0; font-size: 36px; font-weight: 800; }
                    .order-info { text-align: right; }
                    .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; margin-bottom: 30px; }
                    .address-box { border: 2px solid #000; padding: 20px; margin-bottom: 30px; }
                    table { width: 100%; border-collapse: collapse; }
                    th { text-align: left; text-transform: uppercase; font-size: 12px; color: #888; border-bottom: 1px solid #000; padding-bottom: 10px; }
                    .total-section { margin-top: 50px; text-align: right; border-top: 4px solid #000; padding-top: 20px; }
                    .total-section h2 { margin: 0; font-size: 45px; font-weight: 800; }
                </style>
            </head>
            <body>
                <div class="wrapper">
                    <div class="header">
                        <div class="brand"><h1>NARAN</h1><p>–û–§–ò–¶–ò–ê–õ–¨–ù–´–ô –ß–ï–ö –ó–ê–ö–ê–ó–ê</p></div>
                        <div class="order-info"><h2>–ó–ê–ö–ê–ó #${o.order_id}</h2><p>–î–∞—Ç–∞: ${date}</p></div>
                    </div>

                    <div class="info-grid">
                        <div>
                            <small style="color:#888; font-weight:700;">–ü–û–ö–£–ü–ê–¢–ï–õ–¨</small>
                            <p style="font-size: 18px; font-weight: 700; margin: 5px 0;">${o.customer_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                            <p>${o.customer_phone || '---'}</p>
                        </div>
                        <div style="text-align: right;">
                            <small style="color:#888; font-weight:700;">–°–ü–û–°–û–ë –î–û–°–¢–ê–í–ö–ò</small>
                            <p style="font-size: 18px; font-weight: 700; margin: 5px 0;">${o.delivery || o.delivery_type || '–°—Ç–∞–Ω–¥–∞—Ä—Ç'}</p>
                        </div>
                    </div>

                    <div class="address-box">
                        <small style="color:#888; font-weight:700;">–ê–î–†–ï–° –î–û–°–¢–ê–í–ö–ò:</small>
                        <p style="font-size: 22px; font-weight: 800; margin: 10px 0 0 0;">${o.address || '–°–∞–º–æ–≤—ã–≤–æ–∑ / –ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    </div>

                    <table>
                        <thead>
                            <tr>
                                <th>–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–≤</th>
                                <th style="text-align: right;">–°—É–º–º–∞</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>

                    <div class="total-section">
                        <div style="font-weight: 700; color: #888;">–ò–¢–û–ì–û –ö –û–ü–õ–ê–¢–ï</div>
                        <h2>${o.order_total || o.total_price || 0} ‚ÇΩ</h2>
                    </div>

                    <div style="margin-top: 50px; text-align: center; color: #888; font-size: 12px;">
                        –°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –≤—ã–±–æ—Ä! –ë—É–¥–µ–º —Ä–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞ –≤ NARAN.
                    </div>
                </div>
                <script>
                    window.onload = function() { 
                        window.print(); 
                        setTimeout(() => { window.close(); }, 500); 
                    };
                <\/script>
            </body>
            </html>
        `);
        win.document.close();
    } catch (e) {
        console.error(e);
        alert("–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –±—Ä–∞—É–∑–µ—Ä–∞.");
    }
},
getProductrating(productId) {
        // –§–∏–ª—å—Ç—Ä—É–µ–º –≤—Å–µ –æ—Ç–∑—ã–≤—ã, –æ—Å—Ç–∞–≤–ª—è—è —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –æ—Ç–Ω–æ—Å—è—Ç—Å—è –∫ —ç—Ç–æ–º—É —Ç–æ–≤–∞—Ä—É
        const productReviews = this.allReviews.filter(r => r.productId === productId);
        
        if (productReviews.length === 0) return 0; // –ï—Å–ª–∏ –æ—Ç–∑—ã–≤–æ–≤ –Ω–µ—Ç, —Ä–µ–π—Ç–∏–Ω–≥ 0
        
        // –°—É–º–º–∏—Ä—É–µ–º –≤—Å–µ –æ—Ü–µ–Ω–∫–∏
        const sum = productReviews.reduce((acc, rev) => acc + rev.rating, 0);
        
        // –î–µ–ª–∏–º —Å—É–º–º—É –Ω–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ç–∑—ã–≤–æ–≤ –∏ –æ–∫—Ä—É–≥–ª—è–µ–º –¥–æ 1 –∑–Ω–∞–∫–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 4.8)
        return (sum / productReviews.length).toFixed(1);
    },
    openReviewModal(order, item) {
            this.vib();
            console.log("–ö–ª–∏–∫ —Å—Ä–∞–±–æ—Ç–∞–ª!", order.id, item.title); // –î–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
            this.selectedOrderForReview = order;
            this.selectedProductForReview = item;

            this.rating = 0;
            this.reviewText = '';
            this.reviewImages = [];

            this.showReviewModal = true;
            if (this.vib) this.vib(); // –í–∏–±—Ä–∞—Ü–∏—è 
        },
     // –°—Ç—Ä–æ–∫–∞ ~1060 (–≤–Ω—É—Ç—Ä–∏ methods)
async uploadReviewImages(e) {
            const files = e.target.files;
            for (let f of files) {
                if (this.reviewImages.length >= 3) break;
                const fd = new FormData();
                fd.append('image', f);
                try {
                    const r = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body: fd });
                    const d = await r.json();
                    if (d.data?.url) this.reviewImages.push(d.data.url);
                } catch (err) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ"); }
            }
        },

async submitFinalReview() {
    // 1. –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    if (this.rating === 0) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ—Å—Ç–∞–≤—å—Ç–µ –æ—Ü–µ–Ω–∫—É (–∑–≤–µ–∑–¥—ã)!");
        return;
    }
    if (this.reviewText.trim().length < 5) {
        alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–µ–±–æ–ª—å—à–æ–π –æ—Ç–∑—ã–≤ (—Ö–æ—Ç—è –±—ã –ø–∞—Ä—É —Å–ª–æ–≤).");
        return;
    }
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –Ω–∞–∂–∞—Ç–∏—è, –ø–æ–∫–∞ –∏–¥–µ—Ç –∑–∞–≥—Ä—É–∑–∫–∞
    if (this.loading) return;

    try {
        this.loading = true;
        this.vib(); // –í–∏–±—Ä–∞—Ü–∏—è –ø—Ä–∏ –Ω–∞—á–∞–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏

        // 2. –§–æ—Ä–º–∏—Ä—É–µ–º –æ–±—ä–µ–∫—Ç –æ—Ç–∑—ã–≤–∞
        const reviewData = {
            productId: this.selectedProductForReview.id,
            productTitle: this.selectedProductForReview.title || "–¢–æ–≤–∞—Ä", // –ü–æ–ª–µ–∑–Ω–æ –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏
            orderId: this.selectedOrderForReview.id,
            userId: this.user.id || 0,
            userName: this.user.first_name || "–ö–ª–∏–µ–Ω—Ç",
            rating: Number(this.rating),
            text: this.reviewText.trim(),
            images: this.reviewImages || [],
            createdAt: window.fb.serverTimestamp() 
        };

        // 3. –í—ã–ø–æ–ª–Ω—è–µ–º –æ–±–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ (Batch-–ø–æ–¥–æ–±–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
        // –≠—Ç–æ —É—Å–∫–æ—Ä—è–µ—Ç —Ä–∞–±–æ—Ç—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        await Promise.all([
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç–∑—ã–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—é reviews
            window.fb.addDoc(window.fb.collection(window.db, "reviews"), reviewData),
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–∫–∞–∑ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ orders
            window.fb.updateDoc(window.fb.doc(window.db, "orders", this.selectedOrderForReview.id), {
                reviewed: true,
                reviewedAt: window.fb.serverTimestamp()
            })
        ]);

        // 4. –û—á–∏—Å—Ç–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
        this.showReviewModal = false;
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–ª—è, —á—Ç–æ–±—ã –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –¥–ª—è –¥—Ä—É–≥–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –æ–∫–Ω–æ –±—ã–ª–æ –ø—É—Å—Ç—ã–º
        this.rating = 0;
        this.reviewText = "";
        this.reviewImages = [];
        this.selectedProductForReview = null;

        alert("–°–ø–∞—Å–∏–±–æ! –í–∞—à –æ—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω. ‚ù§Ô∏è");
        
    } catch (e) {
        console.error("Firebase Error:", e);
        alert("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.");
    } finally {
        this.loading = false;
    }
},
updateChart() {
    const ctx = document.getElementById('salesChart');
    if (!ctx) return;

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞—Ç—ã –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 7 –¥–Ω–µ–π
    const labels = [];
    const counts = [];
    const now = new Date();

    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(now.getDate() - i);
        labels.push(d.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }));
        
        // –°—á–∏—Ç–∞–µ–º –∑–∞–∫–∞–∑—ã –∑–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å
        const dayStart = new Date(d.setHours(0,0,0,0)).getTime();
        const dayEnd = new Date(d.setHours(23,59,59,999)).getTime();
        
        const dayOrders = this.allOrders.filter(o => {
            const t = o.createdAt?.seconds ? o.createdAt.seconds * 1000 : 0;
            return t >= dayStart && t <= dayEnd;
        });
        counts.push(dayOrders.length);
    }

    if (this.chart) this.chart.destroy();

    this.chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: '–ó–∞–∫–∞–∑—ã',
                data: counts,
                borderColor: '#000',
                backgroundColor: 'rgba(0,0,0,0.05)',
                borderWidth: 3,
                tension: 0.4, // –î–µ–ª–∞–µ—Ç –ª–∏–Ω–∏—é –ø–ª–∞–≤–Ω–æ–π (–ø—Ä–µ–º–∏–∞–ª—å–Ω–æ)
                fill: true,
                pointRadius: 4,
                pointBackgroundColor: '#000'
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { display: false } },
            scales: {
                y: { beginAtZero: true, grid: { display: false }, ticks: { stepSize: 1 } },
                x: { grid: { display: false } }
            }
        }
    });
}
    },
   mounted() {
    tg.ready();
    tg.expand();

    // 1. –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const tgUser = tg.initDataUnsafe?.user;
    
    if (tgUser) {
        this.user = tgUser;
    } else {
        this.user = { id: 0, first_name: '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å' };
        console.warn("–î–∞–Ω–Ω—ã–µ Telegram –Ω–µ –ø–æ–ª—É—á–µ–Ω—ã. –†–∞–±–æ—Ç–∞ –≤ —Ä–µ–∂–∏–º–µ –≥–æ—Å—Ç—è.");
    }

    const checkFb = setInterval(() => {
        if (window.db && window.fb) {
            clearInterval(checkFb);

            // 2. –ü–†–û–í–ï–†–ö–ê –ê–î–ú–ò–ù–ê (–¥–µ–ª–∞–µ–º –≤–Ω—É—Ç—Ä–∏, —á—Ç–æ–±—ã adminId —Ç–æ—á–Ω–æ –±—ã–ª –¥–æ—Å—Ç—É–ø–µ–Ω)
            if (this.user && this.user.id && this.adminId) {
                const currentId = String(this.user.id).trim();
                const adminIdInCode = String(this.adminId).trim();
                
                this.isAdmin = (currentId === adminIdInCode);
                
                console.log("–í–∞—à ID:", currentId);
                console.log("ID –∞–¥–º–∏–Ω–∞:", adminIdInCode);
                console.log("–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:", this.isAdmin);
            }

            // 3. –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤, –∫–∞—Ç–µ–≥–æ—Ä–∏–π –∏ –æ—Ç–∑—ã–≤–æ–≤ (–æ–±—â–∏–µ –¥–∞–Ω–Ω—ã–µ)
            window.fb.onSnapshot(window.fb.query(window.fb.collection(window.db, "products"), window.fb.orderBy("createdAt", "desc")), snap => {
                this.products = snap.docs.map(doc => ({ id: doc.id, ...doc.data(), aIdx: 0 }));
            });

            window.fb.onSnapshot(window.fb.collection(window.db, "categories"), snap => {
                this.categories = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });

            window.fb.onSnapshot(window.fb.collection(window.db, "reviews"), snap => {
                this.allReviews = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            });

            // 4. –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∑–∞–∫–∞–∑–æ–≤ (–¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–ê)
            if (this.isAdmin) {
                const ordersQuery = window.fb.query(window.fb.collection(window.db, "orders"), window.fb.orderBy("createdAt", "desc"));
                window.fb.onSnapshot(ordersQuery, snap => {
                    this.allOrders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.$nextTick(() => { 
                        if (typeof this.updateChart === 'function') this.updateChart(); 
                    });
                });
            }

            // 5. –ó–∞–≥—Ä—É–∑–∫–∞ –ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ (–î–õ–Ø –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø)
            if (this.user && this.user.id !== 0) {
                // –ü–†–û–í–ï–†–ö–ê: –ø—Ä–æ–±—É–µ–º –∏—Å–∫–∞—Ç—å –∏ –ø–æ —á–∏—Å–ª—É, –∏ –ø–æ —Å—Ç—Ä–æ–∫–µ, –µ—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω—ã –≤ —Ç–∏–ø–µ –¥–∞–Ω–Ω—ã—Ö –≤ –ë–î
                const qMy = window.fb.query(
                    window.fb.collection(window.db, "orders"), 
                    window.fb.where("user.id", "in", [Number(this.user.id), String(this.user.id)])
                );
                
                window.fb.onSnapshot(qMy, snap => {
                    this.myOrders = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                });
            }
        }
    }, 100);
}
}).mount('#app');
</script>

</body>
</html>
