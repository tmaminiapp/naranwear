<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NARAN</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://mapgl.2gis.com/api/js/v1"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;800&display=swap" rel="stylesheet">
    
    <style>
        :root { 
            --bg: #ffffff; 
            --text: #000000;
            --gray-light: #f4f4f4;
            --accent: #000000;
            --red: #ff0000;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }
        body { margin: 0; background: var(--bg); font-family: 'Montserrat', sans-serif; color: var(--text); overflow-x: hidden; }

        /* UI */
        .btn-black { background: #000; color: #fff; border: none; padding: 15px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; border-radius: 2px; width: 100%; }
        .btn-outline { background: transparent; color: #000; border: 1px solid #000; padding: 10px; font-weight: 600; border-radius: 2px; cursor: pointer; }
        
        /* Header */
        .header { 
            background: #fff; padding: 15px; display: flex; align-items: center; justify-content: space-between;
            position: sticky; top: 0; z-index: 1000; border-bottom: 1px solid #eee;
        }
        .brand-name { font-weight: 800; font-size: 20px; letter-spacing: 3px; cursor: pointer; }

        .search-bar { padding: 10px 15px; background: #fff; border-bottom: 1px solid #eee; display: flex; align-items: center; }
        .search-input { border: none; width: 100%; font-family: inherit; font-size: 14px; padding: 5px; outline: none; }

        /* Catalog & Grid */
        .container { padding: 15px; padding-bottom: 120px; min-height: 100vh; }
        .cat-row { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 15px; scrollbar-width: none; }
        .cat-row::-webkit-scrollbar { display: none; }
        .cat-item { 
            padding: 10px 20px; border: 1px solid #000; font-size: 10px; font-weight: 600; 
            text-transform: uppercase; white-space: nowrap; cursor: pointer; border-radius: 2px;
        }
        .cat-item.active { background: #000; color: #fff; }

        .products-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .card { background: #fff; position: relative; display: flex; flex-direction: column; cursor: pointer; }
        
        .slider-wrapper { position: relative; width: 100%; aspect-ratio: 3/4; overflow: hidden; background: #f9f9f9; }
        .slider-inner { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; height: 100%; }
        .slider-inner::-webkit-scrollbar { display: none; }
        .slider-inner img { width: 100%; height: 100%; object-fit: cover; scroll-snap-align: start; flex-shrink: 0; }
        
        .dots { position: absolute; bottom: 8px; width: 100%; display: flex; justify-content: center; gap: 4px; }
        .dot { width: 4px; height: 4px; background: rgba(0,0,0,0.2); border-radius: 50%; }
        .dot.active { background: #000; width: 10px; border-radius: 2px; }

        .card-info { padding: 8px 0; }
        .card-title { font-size: 11px; font-weight: 400; text-transform: uppercase; margin-bottom: 4px; height: 14px; overflow: hidden; }
        .card-price { font-weight: 800; font-size: 13px; }
        .old-price { text-decoration: line-through; color: #999; font-size: 11px; margin-left: 5px; }

        .card-actions { display: flex; gap: 5px; margin-top: 8px; }
        .action-fav-btn { width: 35px; border: 1px solid #eee; background: #fff; display: flex; align-items: center; justify-content: center; padding: 0; }

        /* Navigation */
        .bottom-nav { 
            position: fixed; bottom: 0; left: 0; right: 0; background: #fff; 
            display: flex; justify-content: space-around; padding: 12px 0 25px; 
            border-top: 1px solid #eee; z-index: 1000; 
        }
        .nav-item { border: none; background: none; color: #999; display: flex; flex-direction: column; align-items: center; gap: 4px; font-size: 9px; font-weight: 600; position: relative; cursor: pointer; }
        .nav-item.active { color: #000; }
        .nav-item svg { width: 22px; height: 22px; }
        .badge { position: absolute; top: -5px; right: -5px; background: var(--red); color: #fff; font-size: 8px; padding: 2px 5px; border-radius: 10px; font-weight: 800; }

        /* Full View & Screens */
        .screen-view { position: fixed; inset: 0; background: #fff; z-index: 2000; overflow-y: auto; padding-bottom: 80px; }
        .close-screen { position: fixed; top: 20px; right: 20px; z-index: 2100; background: #000; color: #fff; width: 35px; height: 35px; border: none; border-radius: 50%; font-size: 18px; }
        
        .size-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 15px 0; }
        .size-box { border: 1px solid #eee; padding: 12px; text-align: center; font-size: 12px; cursor: pointer; transition: 0.2s; }
        .size-box.active { border-color: #000; background: #000; color: #fff; }

        /* Map */
        #map { width: 100%; height: 300px; margin: 15px 0; border: 1px solid #000; }

        /* Admin Styles */
        .admin-panel { background: #fdfdfd; border: 2px solid #000; padding: 15px; margin-top: 20px; }
        .admin-section { margin-bottom: 25px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-size: 10px; font-weight: 800; text-transform: uppercase; margin-bottom: 6px; }
        .input-std { width: 100%; padding: 12px; border: 1px solid #000; font-family: 'Montserrat'; font-size: 14px; }
        
        .order-card { border: 1px solid #eee; padding: 12px; margin-bottom: 10px; font-size: 12px; }
        .status-tag { padding: 4px 8px; font-size: 10px; font-weight: 800; text-transform: uppercase; }

        /* Animations */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
    </style>
</head>
<body>

<div id="app">
    <header class="header">
        <button @click="activeTab = 'info'; vibrate()" style="background:none; border:none; padding: 5px;">
            <svg viewBox="0 0 24 24" width="24" fill="none" stroke="black" stroke-width="1.5"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
        </button>
        <div class="brand-name" @click="activeTab = 'catalog'; vibrate()">NARAN</div>
        <button @click="showSearch = !showSearch; vibrate()" style="background:none; border:none; padding: 5px;">
            <svg viewBox="0 0 24 24" width="22" fill="none" stroke="black" stroke-width="1.5"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
        </button>
    </header>

    <div v-if="showSearch" class="search-bar">
        <input v-model="searchQuery" class="search-input" placeholder="–ü–û–ò–°–ö –ü–û –ù–ê–ó–í–ê–ù–ò–Æ..." autofocus @input="vibrate()">
    </div>

    <main class="container">
        
        <div v-if="activeTab === 'catalog'">
            <div class="cat-row">
                <div class="cat-item" :class="{active: currentCat === ''}" @click="currentCat = ''; vibrate()">–í—Å–µ —Ç–æ–≤–∞—Ä—ã</div>
                <div v-for="cat in categories" :key="cat" class="cat-item" :class="{active: currentCat === cat}" @click="currentCat = cat; vibrate()">{{cat}}</div>
            </div>

            <div class="products-grid">
                <div v-for="p in filteredProducts" :key="p.id" class="card" @click="openProduct(p)">
                    <div class="slider-wrapper">
                        <div class="slider-inner" @scroll="e => handleScroll(e, p)">
                            <img v-for="img in p.images" :src="img" loading="lazy">
                        </div>
                        <div class="dots" v-if="p.images?.length > 1">
                            <span v-for="(img, idx) in p.images" class="dot" :class="{active: idx === (p.aIdx || 0)}"></span>
                        </div>
                    </div>
                    <div class="card-info">
                        <div class="card-title">{{p.title}}</div>
                        <div class="card-price">
                            {{p.price}} ‚ÇΩ <span v-if="p.oldPrice" class="old-price">{{p.oldPrice}} ‚ÇΩ</span>
                        </div>
                    </div>
                </div>
            </div>
            <div v-if="filteredProducts.length === 0" style="text-align: center; padding: 50px; color: #999;">–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>
        </div>

        <div v-if="activeTab === 'info'">
            <h2 style="letter-spacing: 2px; font-weight: 300;">–ò–ù–§–û–†–ú–ê–¶–ò–Ø</h2>
            <div style="display: flex; flex-direction: column; gap: 20px; margin-top: 30px;">
                <div @click="openModalInfo('about')" class="btn-outline" style="text-align: center;">–û –ù–ê–°</div>
                <div @click="openModalInfo('delivery')" class="btn-outline" style="text-align: center;">–î–û–°–¢–ê–í–ö–ê</div>
                <div @click="openModalInfo('returns')" class="btn-outline" style="text-align: center;">–í–û–ó–í–†–ê–¢</div>
                <div @click="activeTab = 'catalog'" class="btn-black" style="text-align: center; margin-top: 20px;">–ù–ê–ó–ê–î –í –ö–ê–¢–ê–õ–û–ì</div>
            </div>
        </div>

        <div v-if="activeTab === 'favs'">
            <h2 style="font-weight: 300; letter-spacing: 2px;">–ò–ó–ë–†–ê–ù–ù–û–ï</h2>
            <div v-if="favItems.length === 0" style="text-align:center; padding: 100px 0; color: #999;">–í —Å–ø–∏—Å–∫–µ –ø–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ—Ç</div>
            <div class="products-grid">
                <div v-for="p in favItems" :key="p.id" class="card" @click="openProduct(p)">
                    <img :src="p.img" style="width:100%; aspect-ratio:3/4; object-fit:cover;">
                    <div class="card-info">
                        <div class="card-title">{{p.title}}</div>
                        <div class="card-price">{{p.price}} ‚ÇΩ</div>
                    </div>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'cart'">
            <h2 style="font-weight: 300; letter-spacing: 2px;">–ö–û–†–ó–ò–ù–ê</h2>
            <div v-if="cart.length === 0" style="text-align:center; padding: 100px 0; color: #999;">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div>
            <div v-else>
                <div v-for="(item, idx) in cart" :key="item.cartId" style="display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
                    <img :src="item.img" style="width: 80px; height: 100px; object-fit: cover;">
                    <div style="flex: 1;">
                        <div style="font-size: 12px; font-weight: 700; text-transform: uppercase;">{{item.title}}</div>
                        <div style="font-size: 10px; color: #666; margin: 4px 0;">–†–∞–∑–º–µ—Ä: {{item.selectedSize}}</div>
                        <div style="font-weight: 800;">{{item.price}} ‚ÇΩ</div>
                        <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                            <button @click="updateQty(idx, -1)" style="border: 1px solid #000; background: none; width: 30px; height: 30px;">-</button>
                            <span style="font-weight: 800;">{{item.qty || 1}}</span>
                            <button @click="updateQty(idx, 1)" style="border: 1px solid #000; background: none; width: 30px; height: 30px;">+</button>
                        </div>
                    </div>
                    <button @click="removeFromCart(idx)" style="background: none; border: none; font-size: 20px;">‚úï</button>
                </div>

                <div style="margin-top: 30px; background: #fafafa; padding: 20px;">
                    <h4 style="margin-top: 0;">–û–§–û–†–ú–õ–ï–ù–ò–ï</h4>
                    <div class="input-group">
                        <label>–í–∞—à–µ –ò–º—è</label>
                        <input v-model="form.name" class="input-std" placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤">
                    </div>
                    <div class="input-group">
                        <label>–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input v-model="form.phone" class="input-std" type="tel" placeholder="79001234567">
                    </div>
                    
                    <label style="font-size: 10px; font-weight: 800;">–°–ü–û–°–û–ë –î–û–°–¢–ê–í–ö–ò</label>
                    <div style="display: flex; gap: 8px; margin: 10px 0;">
                        <button v-for="d in ['–°–î–≠–ö', '–ü–æ—á—Ç–∞', '5Post']" @click="setDelivery(d)" :class="['btn-outline', deliv === d ? 'active' : '']" style="flex: 1; font-size: 10px; border: 1px solid #000;" :style="deliv === d ? 'background:#000;color:#fff':''">
                            {{d}}
                        </button>
                    </div>

                    <div v-if="deliv">
                        <div style="font-size: 11px; margin: 10px 0; background: #000; color: #fff; padding: 12px; font-weight: 600;">
                            üìç {{address || '–í—ã–±–µ—Ä–∏—Ç–µ –ü–í–ó –Ω–∞ –∫–∞—Ä—Ç–µ –Ω–∏–∂–µ'}}
                        </div>
                        <div id="map"></div>
                    </div>

                    <button class="btn-black" style="margin-top: 20px;" @click="checkout" :disabled="!isFormValid">
                        –û–§–û–†–ú–ò–¢–¨ –ó–ê–ö–ê–ó ‚Äî {{total}} ‚ÇΩ
                    </button>
                </div>
            </div>
        </div>

        <div v-if="activeTab === 'profile'">
            <div style="text-align: center; margin-bottom: 30px; padding: 20px; border: 1px solid #eee;">
                <img :src="user.photo_url || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'" style="width: 70px; height: 70px; border-radius: 50%; border: 1px solid #000; padding: 3px;">
                <h3 style="margin: 15px 0 5px; text-transform: uppercase;">{{user.first_name || '–ü–æ–∫—É–ø–∞—Ç–µ–ª—å'}}</h3>
                <div style="display: flex; justify-content: center; gap: 10px; margin-top: 15px;">
                    <button @click="tg.openTelegramLink('https://t.me/opttania')" class="btn-outline" style="font-size: 10px;">–ü–û–î–î–ï–†–ñ–ö–ê</button>
                </div>
            </div>

            <div style="margin-bottom: 40px;">
                <h4 style="text-transform: uppercase; font-size: 12px; border-bottom: 2px solid #000; padding-bottom: 8px;">–ú–æ–∏ –∑–∞–∫–∞–∑—ã</h4>
                <div v-if="myOrders.length === 0" style="color: #999; font-size: 12px; padding: 20px 0; text-align: center;">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤</div>
                <div v-for="o in myOrders" :key="o.id" class="order-card">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                        <b>‚Ññ {{o.order_id}}</b>
                        <span class="status-tag" :style="{background: getStatusColor(o.status), color: '#fff'}">{{o.status}}</span>
                    </div>
                    <div style="color: #666;">{{o.total}} ‚ÇΩ ‚Ä¢ {{o.cart?.length}} —Ç–æ–≤.</div>
                </div>
            </div>

            <div v-if="isAdmin" class="admin-panel">
                <h2 style="text-align: center; letter-spacing: 5px; margin-top: 0;">ADMIN PANEL</h2>
                
                <div class="admin-section">
                    <h4>–î–û–ë–ê–í–ò–¢–¨ –¢–û–í–ê–†</h4>
                    <div class="input-group"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input v-model="newP.title" class="input-std"></div>
                    <div class="input-group"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><textarea v-model="newP.desc" class="input-std" rows="3"></textarea></div>
                    <div style="display: flex; gap: 10px;">
                        <div class="input-group" style="flex:1"><label>–¶–µ–Ω–∞</label><input v-model.number="newP.price" class="input-std"></div>
                        <div class="input-group" style="flex:1"><label>–°—Ç–∞—Ä–∞—è —Ü–µ–Ω–∞</label><input v-model.number="newP.oldPrice" class="input-std"></div>
                    </div>
                    <div class="input-group">
                        <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select v-model="newP.category" class="input-std">
                            <option value="">–í—ã–±—Ä–∞—Ç—å...</option>
                            <option v-for="cat in categories" :value="cat">{{cat}}</option>
                        </select>
                    </div>
                    <div class="input-group"><label>–†–∞–∑–º–µ—Ä—ã (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)</label><input v-model="newP.sizesInput" class="input-std"></div>
                    
                    <div style="margin: 15px 0;">
                        <input type="file" multiple @change="handleFileUpload" id="fileInput" style="display:none">
                        <button class="btn-outline" style="width: 100%; border-style: dashed;" @click="triggerFiles" :disabled="uploading">
                            {{ uploading ? '–ó–ê–ì–†–£–ó–ö–ê –§–û–¢–û...' : '+ –ó–ê–ì–†–£–ó–ò–¢–¨ –§–û–¢–û (ImgBB)' }}
                        </button>
                        <div style="display: flex; gap: 8px; margin-top: 10px; overflow-x: auto; padding-bottom: 5px;">
                            <img v-for="(url, idx) in newP.images" :key="idx" :src="url" style="width: 60px; height: 80px; object-fit: cover; border: 1px solid #000;">
                        </div>
                    </div>
                    <button class="btn-black" @click="saveProduct">–°–û–•–†–ê–ù–ò–¢–¨ –í –ö–ê–¢–ê–õ–û–ì</button>
                </div>

                <div class="admin-section">
                    <h4>–£–ü–†–ê–í–õ–ï–ù–ò–ï –ó–ê–ö–ê–ó–ê–ú–ò</h4>
                    <div v-for="order in orders" :key="order.id" class="order-card">
                        <div><b>{{order.order_id}}</b> | {{order.user?.name}}</div>
                        <div style="margin: 5px 0;">{{order.total}} ‚ÇΩ | {{order.delivery}}</div>
                        <select @change="updateOrderStatus(order.id, $event.target.value)" :value="order.status" class="input-std" style="padding: 5px; font-size: 11px;">
                            <option>–í –æ–±—Ä–∞–±–æ—Ç–∫–µ</option>
                            <option>–û–ø–ª–∞—á–µ–Ω–æ</option>
                            <option>–í –ø—É—Ç–∏</option>
                            <option>–ì–æ—Ç–æ–≤</option>
                            <option>–û—Ç–º–µ–Ω–µ–Ω</option>
                        </select>
                    </div>
                </div>

                <div class="admin-section">
                    <h4>–í–°–ï –¢–û–í–ê–†–´ ({{products.length}})</h4>
                    <div v-for="p in products" :key="p.id" style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px; border-bottom: 1px solid #eee; padding-bottom: 8px;">
                        <img :src="p.img" style="width: 40px; height: 50px; object-fit: cover;">
                        <div style="flex: 1; font-size: 11px;">{{p.title}}<br><b>{{p.price}} ‚ÇΩ</b></div>
                        <button @click="toggleProductStatus(p)" class="btn-outline" style="font-size: 9px; padding: 5px;">{{ p.hidden ? '–ü–û–ö–ê–ó–ê–¢–¨' : '–°–ö–†–´–¢–¨' }}</button>
                        <button @click="deleteProduct(p.id)" style="color: red; border: none; background: none; font-size: 18px;">‚úï</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <transition name="fade">
        <div v-if="selP" class="screen-view">
            <button class="close-screen" @click="selP = null">‚úï</button>
            <div class="slider-wrapper" style="aspect-ratio: 1/1;">
                <div class="slider-inner" @scroll="e => handleScroll(e, selP)">
                    <img v-for="img in selP.images" :src="img">
                </div>
                <div class="dots" v-if="selP.images?.length > 1">
                    <span v-for="(img, idx) in selP.images" class="dot" :class="{active: idx === (selP.aIdx || 0)}"></span>
                </div>
            </div>
            
            <div style="padding: 25px;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <h1 style="font-size: 20px; text-transform: uppercase; margin: 0; font-weight: 800;">{{selP.title}}</h1>
                    <div style="text-align: right;">
                        <div style="font-size: 22px; font-weight: 800;">{{selP.price}} ‚ÇΩ</div>
                        <div v-if="selP.oldPrice" style="text-decoration: line-through; color: #999; font-size: 14px;">{{selP.oldPrice}} ‚ÇΩ</div>
                    </div>
                </div>
                
                <p style="font-size: 14px; line-height: 1.6; color: #333; margin: 25px 0;">{{selP.desc}}</p>

                <div style="margin: 25px 0;">
                    <label style="font-size: 10px; font-weight: 800; letter-spacing: 1px;">–í–´–ë–ï–†–ò–¢–ï –†–ê–ó–ú–ï–†</label>
                    <div class="size-grid">
                        <div v-for="s in selP.sizes" :key="s" class="size-box" :class="{active: selP.selectedSize === s}" @click="selP.selectedSize = s; vibrate()">
                            {{s}}
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 10px; position: sticky; bottom: 0; background: #fff; padding-top: 10px;">
                    <button class="btn-outline" style="width: 60px; height: 55px; display: flex; align-items: center; justify-content: center;" @click="toggleFav(selP)">
                        <svg :fill="isFav(selP) ? 'black' : 'none'" stroke="black" stroke-width="1.5" viewBox="0 0 24 24" width="24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    </button>
                    <button class="btn-black" style="flex: 1; height: 55px;" @click="addToCart(selP)">–í –ö–û–†–ó–ò–ù–£</button>
                </div>
            </div>
        </div>
    </transition>

    <nav class="bottom-nav">
        <button @click="activeTab = 'catalog'; vibrate()" :class="['nav-item', activeTab === 'catalog' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
            <span>–ö–ê–¢–ê–õ–û–ì</span>
        </button>
        <button @click="activeTab = 'favs'; vibrate()" :class="['nav-item', activeTab === 'favs' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
            <span>–ò–ó–ë–†–ê–ù–ù–û–ï</span>
        </button>
        <button @click="activeTab = 'cart'; vibrate()" :class="['nav-item', activeTab === 'cart' ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z"></path><line x1="3" y1="6" x2="21" y2="6"></line><path d="M16 10a4 4 0 0 1-8 0"></path></svg>
            <span v-if="cart.length > 0" class="badge">{{cart.length}}</span>
            <span>–ö–û–†–ó–ò–ù–ê</span>
        </button>
        <button @click="activeTab = 'profile'; vibrate()" :class="['nav-item', (activeTab === 'profile' || activeTab === 'admin') ? 'active' : '']">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
            <span>–ü–†–û–§–ò–õ–¨</span>
        </button>
    </nav>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, where } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyC6fihIMtOYZuPh-db3Tc6eiRgSikzydVw",
        authDomain: "naran-80077.firebaseapp.com",
        projectId: "naran-80077",
        storageBucket: "naran-80077.firebasestorage.app",
        messagingSenderId: "901156477154",
        appId: "IG-PR8PLCMF3C"
    };

    const fbApp = initializeApp(firebaseConfig);
    const db = getFirestore(fbApp);

    const { createApp } = Vue;
    const tg = window.Telegram.WebApp;

    createApp({
        data() {
            return {
                tg,
                activeTab: 'catalog',
                products: [],
                orders: [],
                myOrders: [],
                categories: ['–ø–∏–¥–∂–∞–∫–∏', '—Å–≤–∏—Ç–µ—Ä—ã', '–∫–∞—Ä–¥–∏–≥–∞–Ω—ã', '–∫–æ—Å—Ç—é–º—ã', '–ª–æ–Ω–≥—Å–ª–∏–≤—ã', '—Ñ—É—Ç–±–æ–ª–∫–∏', '–∫–æ—Ä—Å–µ—Ç—ã', '–∫—É—Ä—Ç–∫–∏', '—ç–∫–æ—à—É–±—ã'],
                currentCat: '',
                searchQuery: '',
                showSearch: false,
                uploading: false,
                isAdmin: false,
                adminId: 387881523, 
                user: {},
                cart: JSON.parse(localStorage.getItem('n_cart') || '[]'),
                favorites: JSON.parse(localStorage.getItem('n_favs') || '[]'),
                selP: null,
                deliv: '',
                address: localStorage.getItem('n_last_adr') || '',
                form: { name: '', phone: localStorage.getItem('n_phone') || '' },
                newP: { title: '', desc: '', price: '', oldPrice: '', category: '', images: [], sizesInput: '42, 44, 46' },
                map: null
            }
        },
        computed: {
            filteredProducts() {
                try {
                    let list = this.products;
                    if (this.currentCat !== '') {
                        list = list.filter(p => p.category === this.currentCat);
                    }
                    if (this.searchQuery) {
                        list = list.filter(p => p.title.toLowerCase().includes(this.searchQuery.toLowerCase()));
                    }
                    // –ê–¥–º–∏–Ω –≤–∏–¥–∏—Ç —Å–∫—Ä—ã—Ç—ã–µ, –∫–ª–∏–µ–Ω—Ç - –Ω–µ—Ç
                    return this.isAdmin ? list : list.filter(p => !p.hidden);
                } catch(e) { return []; }
            },
            favItems() {
                return this.products.filter(p => this.favorites.includes(p.id));
            },
            total() {
                return this.cart.reduce((s, i) => s + (i.price * (i.qty || 1)), 0);
            },
            isFormValid() {
                const phoneReg = /^\d{10,11}$/;
                return this.form.name.length > 1 && phoneReg.test(this.form.phone) && this.address;
            }
        },
        methods: {
            vibrate() { tg.HapticFeedback.impactOccurred('medium'); },
            handleScroll(e, p) { 
                if(!p) return;
                p.aIdx = Math.round(e.target.scrollLeft / e.target.offsetWidth); 
            },
            openProduct(p) {
                this.vibrate();
                this.selP = { ...p, selectedSize: p.sizes ? p.sizes[0] : '' };
            },
            toggleFav(p) {
                this.vibrate();
                const idx = this.favorites.indexOf(p.id);
                if (idx > -1) this.favorites.splice(idx, 1);
                else this.favorites.push(p.id);
                localStorage.setItem('n_favs', JSON.stringify(this.favorites));
            },
            isFav(p) { return this.favorites.includes(p.id); },
            addToCart(p) {
                if (!p.selectedSize) { tg.showAlert("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–º–µ—Ä"); return; }
                const item = { 
                    cartId: Date.now(), 
                    id: p.id, 
                    title: p.title, 
                    price: p.price, 
                    img: p.img, 
                    selectedSize: p.selectedSize, 
                    qty: 1 
                };
                this.cart.push(item);
                localStorage.setItem('n_cart', JSON.stringify(this.cart));
                this.selP = null;
                tg.HapticFeedback.notificationOccurred('success');
            },
            removeFromCart(idx) {
                this.cart.splice(idx, 1);
                localStorage.setItem('n_cart', JSON.stringify(this.cart));
            },
            updateQty(idx, val) {
                this.cart[idx].qty = Math.max(1, (this.cart[idx].qty || 1) + val);
                localStorage.setItem('n_cart', JSON.stringify(this.cart));
            },
            setDelivery(d) {
                this.deliv = d;
                this.vibrate();
                this.$nextTick(() => this.initMap());
            },
            initMap() {
                if (this.map) { this.map.destroy(); }
                const mapCont = document.getElementById('map');
                if(!mapCont) return;
                
                this.map = new mapgl.Map('map', {
                    center: [37.6175, 55.7558],
                    zoom: 13,
                    key: 'cab82c94-e619-42eb-9814-3361712feaf0'
                });
                
                this.map.on('click', (e) => {
                    const [lon, lat] = e.lngLat;
                    this.fetchAddress(lat, lon);
                });

                navigator.geolocation.getCurrentPosition(p => {
                    this.map.setCenter([p.coords.longitude, p.coords.latitude]);
                    this.fetchAddress(p.coords.latitude, p.coords.longitude);
                }, () => {});
            },
            fetchAddress(lat, lon) {
                fetch(`https://catalog.api.2gis.com/3.0/items/geocode?lat=${lat}&lon=${lon}&fields=items.address&key=cab82c94-e619-42eb-9814-3361712feaf0`)
                .then(r => r.json())
                .then(d => {
                    if (d.result?.items?.length > 0) {
                        this.address = d.result.items[0].address_name || d.result.items[0].name;
                        localStorage.setItem('n_last_adr', this.address);
                    }
                });
            },
            openModalInfo(type) {
                const info = {
                    about: "NARAN PREMIUM ‚Äî –∫–æ–Ω—Ü–µ–ø—Ç—É–∞–ª—å–Ω—ã–π –±—Ä–µ–Ω–¥ –æ–¥–µ–∂–¥—ã, –≤–¥–æ—Ö–Ω–æ–≤–ª–µ–Ω–Ω—ã–π –º–∏–Ω–∏–º–∞–ª–∏–∑–º–æ–º –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–º–∏ —Ñ–æ—Ä–º–∞–º–∏. –ú—ã —Å–æ–∑–¥–∞–µ–º –≤–µ—â–∏, –∫–æ—Ç–æ—Ä—ã–µ –∂–∏–≤—É—Ç –≤–Ω–µ –≤—Ä–µ–º–µ–Ω–∏.",
                    delivery: "–î–æ—Å—Ç–∞–≤–∫–∞ –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏:\n‚Äî –°–î–≠–ö (–ü–í–ó –∏ –∫—É—Ä—å–µ—Ä)\n‚Äî –ü–æ—á—Ç–∞ –†–æ—Å—Å–∏–∏\n‚Äî 5Post (–ø—É–Ω–∫—Ç—ã –≤ –ü—è—Ç–µ—Ä–æ—á–∫–µ)",
                    returns: "–í—ã –º–æ–∂–µ—Ç–µ –≤–µ—Ä–Ω—É—Ç—å —Ç–æ–≤–∞—Ä –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è, –µ—Å–ª–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ –±–∏—Ä–∫–∏ –∏ —Ç–æ–≤–∞—Ä–Ω—ã–π –≤–∏–¥."
                };
                tg.showAlert(info[type]);
            },

            // ADMIN METHODS
            triggerFiles() { document.getElementById('fileInput').click(); },
            async handleFileUpload(e) {
                const files = e.target.files;
                if(!files.length) return;
                this.uploading = true;
                for (let file of files) {
                    const body = new FormData();
                    body.append('image', file);
                    try {
                        const res = await fetch('https://api.imgbb.com/1/upload?key=839e62907e9a52f0159461b7771bcb2f', { method: 'POST', body });
                        const data = await res.json();
                        if (data.success) this.newP.images.push(data.data.url);
                    } catch (err) { tg.showAlert("–û—à–∏–±–∫–∞ ImgBB"); }
                }
                this.uploading = false;
            },
            async saveProduct() {
                if (!this.newP.title || this.newP.images.length === 0 || !this.newP.price) {
                    tg.showAlert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ, —Ü–µ–Ω—É –∏ –¥–æ–±–∞–≤—å—Ç–µ —Ñ–æ—Ç–æ");
                    return;
                }
                try {
                    const data = {
                        title: this.newP.title,
                        desc: this.newP.desc,
                        price: Number(this.newP.price),
                        oldPrice: Number(this.newP.oldPrice) || null,
                        category: this.newP.category,
                        sizes: this.newP.sizesInput.split(',').map(s => s.trim()),
                        images: this.newP.images,
                        img: this.newP.images[0],
                        hidden: false,
                        createdAt: serverTimestamp()
                    };
                    await addDoc(collection(db, "products"), data);
                    tg.showAlert("–¢–æ–≤–∞—Ä —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!");
                    this.newP = { title: '', desc: '', price: '', oldPrice: '', category: '', images: [], sizesInput: '42, 44, 46' };
                } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message); }
            },
            async checkout() {
                this.vibrate();
                const orderId = `${new Date().getDate()}${new Date().getMonth()+1}-${Math.floor(10000+Math.random()*89999)}`;
                const orderData = {
                    order_id: orderId,
                    user: this.form,
                    user_id: this.user.id || 'guest',
                    cart: this.cart,
                    total: this.total,
                    delivery: this.deliv,
                    address: this.address,
                    status: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
                    createdAt: serverTimestamp()
                };

                try {
                    await addDoc(collection(db, "orders"), orderData);
                    localStorage.setItem('n_phone', this.form.phone);
                    
                    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±–æ—Ç—É
                    tg.sendData(JSON.stringify({type: 'new_order', ...orderData}));
                    
                    this.cart = [];
                    localStorage.removeItem('n_cart');
                    tg.showAlert(`–ó–∞–∫–∞–∑ ‚Ññ${orderId} —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç!`);
                    this.activeTab = 'profile';
                } catch(e) { tg.showAlert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏"); }
            },
            getStatusColor(s) {
                const colors = { '–í –ø—É—Ç–∏': '#0055ff', '–ì–æ—Ç–æ–≤': '#00aa00', '–û—Ç–º–µ–Ω–µ–Ω': '#ff0000', '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ': '#ffaa00', '–û–ø–ª–∞—á–µ–Ω–æ': '#000000' };
                return colors[s] || '#999';
            },
            async updateOrderStatus(id, status) {
                await updateDoc(doc(db, "orders", id), { status });
                this.vibrate();
            },
            async toggleProductStatus(p) {
                await updateDoc(doc(db, "products", p.id), { hidden: !p.hidden });
            },
            async deleteProduct(id) {
                if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ç–æ–≤–∞—Ä –Ω–∞–≤—Å–µ–≥–¥–∞?")) await deleteDoc(doc(db, "products", id));
            }
        },
        mounted() {
            tg.ready();
            tg.expand();
            
            if (tg.initDataUnsafe?.user) {
                this.user = tg.initDataUnsafe.user;
                // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –∞–¥–º–∏–Ω–∞
                if (Number(this.user.id) === Number(this.adminId)) {
                    this.isAdmin = true;
                }
            }

            // Real-time –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä—ã
            onSnapshot(query(collection(db, "products"), orderBy("createdAt", "desc")), (snap) => {
                this.products = snap.docs.map(d => ({ id: d.id, ...d.data(), aIdx: 0 }));
            });

            // –î–ª—è –∞–¥–º–∏–Ω–∞ - –≤—Å–µ –∑–∞–∫–∞–∑—ã
            onSnapshot(query(collection(db, "orders"), orderBy("createdAt", "desc")), (snap) => {
                const all = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                this.orders = all;
                // –§–∏–ª—å—Ç—Ä –¥–ª—è –ª–∏—á–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞
                if (this.user.id) {
                    this.myOrders = all.filter(o => o.user_id == this.user.id);
                }
            });
        }
    }).mount('#app');
</script>

</body>
</html>
