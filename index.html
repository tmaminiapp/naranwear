 addToCart(p) {
    if (!p) return;

    // 1. ОПРЕДЕЛЯЕМ РАЗМЕР
    let selSize = '';
    
    // Если пользователь сам нажал на кнопку размера
    if (p.tempSize) {
        selSize = p.tempSize;
    } else if (p.sizes) {
        // ЕСЛИ ПОЛЬЗОВАТЕЛЬ НЕ ВЫБИРАЛ:
        // Разбиваем строку размеров в массив
        const allSizes = String(p.sizes).split(',').map(s => s.trim());
        // Ищем ПЕРВЫЙ размер, которого НЕТ в списке скрытых
        const firstAvailable = allSizes.find(s => !p.hiddenSizes?.includes(s));
        
        // Если нашли живой размер — берем его, если нет — берем первый (страховка)
        selSize = firstAvailable || allSizes[0];
    } else {
        selSize = 'Универсал';
    }

    // 2. ЖЕСТКАЯ ПРОВЕРКА (Блокировка добавления)
    if (p.hiddenSizes && p.hiddenSizes.includes(selSize)) {
        console.warn("Размер скрыт, добавление отменено");
        return; 
    }

    // 3. ЦВЕТ
    const currentColor = p.color || (p.colors && p.colors[p.aIdx] ? p.colors[p.aIdx] : 'Белый');
    
    // 4. ГЕНЕРИРУЕМ ID (обязательно используем selSize)
    const cartId = p.id + selSize + currentColor;
    const exist = this.cart.find(i => i.cartId === cartId);
    
    if (exist) {
        exist.q++;
    } else {
        this.cart.push({
            ...p,
            cartId: cartId,
            selSize: selSize, // Сохраняем именно тот, что прошел проверку
            selColor: currentColor,
            q: 1
        });
    }
    
    this.saveCart();
    this.vib(); // Виброотклик Telegram
    this.showCartNotify = true;
    setTimeout(() => { this.showCartNotify = false; }, 2000);
},
